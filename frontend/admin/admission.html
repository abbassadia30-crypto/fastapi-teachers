<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

<script>
        if (!localStorage.getItem('userEmail')) {
            window.location.replace("../index.html");
        }
    </script>

    <title>Student Admission - Institution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0288d1;
            --secondary: #263238;
            --accent: #00bcd4;
            --bg: #f0f2f5;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; background: var(--bg); 
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* Red/Green Sign Boxes */
        #notification-bar {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 400px; padding: 15px; border-radius: 12px; 
            color: white; text-align: center; transition: 0.4s; z-index: 2000; font-weight: 600;
        }
        .bg-red { background: #ef5350; top: 20px !important; border: 1px solid #b71c1c; }
        .bg-green { background: #66bb6a; top: 20px !important; border: 1px solid #2e7d32; }

        header { 
            padding: 20px; display: flex; align-items: center; 
            justify-content: space-between; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .back-btn {
            background: #f0f2f5; border: none; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-weight: 600; color: var(--secondary);
        }

        header h1 { color: var(--secondary); margin: 0; font-size: 20px; flex: 1; text-align: center; }
        .form-container { padding: 20px; flex: 1; overflow-y: auto; }
        .admission-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; color: var(--secondary); margin-bottom: 5px; }

        input, select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #ddd; font-family: 'Poppins'; outline: none; box-sizing: border-box;
        }
        input:focus { border-color: var(--primary); }

        .flex-row-btn {
            background: #e3f2fd; color: var(--primary); border: none;
            padding: 10px 15px; border-radius: 10px; font-size: 12px;
            font-weight: 600; cursor: pointer; margin-bottom: 20px; width: 100%;
        }

        .submit-btn {
            background: var(--primary); color: white; border: none;
            padding: 15px; width: 100%; border-radius: 15px;
            font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .row-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .del-btn { background: none; border: none; color: #ef5350; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <header>
        <button class="back-btn" onclick="location.href='dashboard.html'">‚Üê Back</button>
        <h1>Admission Desk</h1>
        <div style="width: 70px;"></div> 
    </header>

    <div class="form-container">
        <div class="admission-card">
            <form id="admissionForm">
                <div class="input-group">
                    <label>Student Full Name</label>
                    <input type="text" id="stdName" placeholder="Full legal name" required>
                </div>

                <div class="input-group">
                    <label>Select Section</label>
                    <select id="sectionSelect" onchange="checkCustom(this)" required></select>
                </div>

                <div class="input-group" id="customSectionGroup" style="display:none;">
                    <label>New Section Name</label>
                    <input type="text" id="newSectionInput" placeholder="Enter custom section name">
                </div>

                <div class="input-group">
                    <label>Admission Fee</label>
                    <input type="number" id="stdFee" placeholder="0.00" step="0.01" required>
                </div>

                <div id="flexibleRows"></div>
                <button type="button" class="flex-row-btn" onclick="addNewRow()">+ Add Extra Field</button>
                
                <button type="submit" class="submit-btn" id="subBtn">Complete Admission</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://fastapi-teachers.onrender.com"; 
        const adminEmail = localStorage.getItem('userEmail');
        const token = localStorage.getItem('institutionToken');
        const sectionDropdown = document.getElementById('sectionSelect');

        if (!adminEmail) { window.location.href = "../index.html"; }

        window.onload = () => { 
            populateSections(); 
            loadAdminTemplate(); 
        };

        function showNotify(msg, type) {
            const bar = document.getElementById('notification-bar');
            bar.innerText = msg;
            bar.className = type === 'success' ? 'bg-green' : 'bg-red';
            setTimeout(() => bar.className = '', 3000);
        }

        // Load fields that this specific admin uses frequently
        function loadAdminTemplate() {
            const template = JSON.parse(localStorage.getItem(`template_${adminEmail}`)) || ["Father's Name", "Phone Number"];
            template.forEach(label => addNewRow(label));
        }

        async function populateSections() {
            sectionDropdown.innerHTML = '<option value="" disabled selected>Choose Section</option>';
            
            // Hardcoded defaults for a standard institution
            const defaults = ["Grade 1", "Grade 2", "Grade 3"];
            defaults.forEach(d => addOption(d));

            // FETCH CUSTOM SECTIONS FROM DATABASE
            try {
                const res = await fetch(`${API_URL}/sections`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const sections = await res.json();
                    sections.forEach(sec => addOption(sec.name));
                }
            } catch (e) { console.log("Database sections unavailable"); }

            addOption("+ Add New Section...", "ADD_NEW");
        }

        function addOption(text, value = null) {
            let opt = document.createElement('option');
            opt.value = value || text;
            opt.innerHTML = text;
            sectionDropdown.appendChild(opt);
        }

        function checkCustom(select) {
            document.getElementById('customSectionGroup').style.display = (select.value === "ADD_NEW") ? "block" : "none";
        }

        function addNewRow(labelValue = "") {
            const container = document.getElementById('flexibleRows');
            const rowId = 'row_' + Math.random().toString(36).substr(2, 9);
            const div = document.createElement('div');
            div.className = "row-item";
            div.id = rowId;
            div.innerHTML = `
                <input type="text" placeholder="Field Label" class="extra-key" style="width:35%;" value="${labelValue}">
                <input type="text" placeholder="Value" class="extra-val" style="width:55%;">
                <button type="button" class="del-btn" onclick="document.getElementById('${rowId}').remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        document.getElementById('admissionForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('subBtn');
            btn.disabled = true;
            btn.innerText = "Syncing with Database...";

            let finalSection = sectionDropdown.value;
            if(finalSection === "ADD_NEW") {
                finalSection = document.getElementById('newSectionInput').value;
            }

            const extraData = {};
            const templateLabels = [];
            const keys = document.querySelectorAll('.extra-key');
            const vals = document.querySelectorAll('.extra-val');

            keys.forEach((k, i) => {
                if(k.value.trim() !== "") {
                    extraData[k.value] = vals[i].value;
                    templateLabels.push(k.value);
                }
            });

            const payload = {
                name: document.getElementById('stdName').value,
                section: finalSection,
                fee: parseFloat(document.getElementById('stdFee').value),
                admitted_by: adminEmail,
                extra_fields: extraData
            };

            try {
                const response = await fetch(`${API_URL}/students/admit`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Remember this admin's preferred fields for next time
                    localStorage.setItem(`template_${adminEmail}`, JSON.stringify(templateLabels));
                    showNotify("Admission Successful!", "success");
                    setTimeout(() => location.reload(), 2000);
                } else {
                    const err = await response.json();
                    showNotify(err.detail || "Database Error", "error");
                    btn.disabled = false;
                }
            } catch (err) {
                showNotify("Institution server connection lost", "error");
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>