<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Syllabus Vault | Institution Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6200ee;
      --secondary: #263238;
      --bg: #f4f7f6;
      --white: #ffffff;
      --border: #e0e0e0;
    }

    body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); color: var(--secondary); display: flex; flex-direction: column; height: 100vh; }

    header { background: var(--white); padding: 18px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }

    #notification-bar {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; padding: 15px; border-radius: 12px;
      color: white; text-align: center; transition: 0.4s; z-index: 5000; font-weight: 600;
    }
    .bg-green { background: #00c853 !important; top: 20px !important; }
    .bg-red { background: #ff5252 !important; top: 20px !important; }

    .search-container { padding: 15px 20px; background: var(--white); }
    .search-bar { width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 12px; outline: none; font-size: 14px; box-sizing: border-box; }

    .syllabus-list { flex: 1; overflow-y: auto; padding: 10px 20px 100px; }

    .syllabus-card {
      background: var(--white); border-radius: 18px; padding: 18px; margin-bottom: 15px;
      border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .sub-tag { font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; background: #f3e5f5; padding: 4px 10px; border-radius: 20px; }
    .card-title { font-weight: 700; font-size: 16px; margin-top: 5px; color: var(--secondary); }
    .card-meta { font-size: 11px; color: #888; font-weight: 500; }

    .targets-row { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
    .target-chip { font-size: 9px; background: #eee; padding: 3px 8px; border-radius: 5px; font-weight: 600; }

    .card-actions { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 12px; }
    .btn-edit { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--primary); background: transparent; color: var(--primary); font-weight: 700; font-size: 12px; cursor: pointer; }
    .btn-view { flex: 1; padding: 10px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: 700; font-size: 12px; cursor: pointer; }

    /* Full Screen Editor Modal */
    #editor-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--white); z-index: 1000; display: none; flex-direction: column;
    }
    .editor-content { flex: 1; overflow-y: auto; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #aaa; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-top: 5px; box-sizing: border-box; font-family: inherit; }
    textarea.form-input { height: 120px; resize: none; }
  </style>
</head>
<body>

<div id="notification-bar"></div>

<header>
  <div onclick="history.back()" style="font-size:24px; cursor:pointer;">âœ•</div>
  <span style="font-weight: 800; font-size: 14px;">SYLLABUS ARCHIVE</span>
  <div style="width: 24px;"></div>
</header>

<div class="search-container">
  <input type="text" class="search-bar" placeholder="Search by subject or title..." onkeyup="filterSyllabus(this.value)">
</div>

<div class="syllabus-list" id="syllabus-container">
  <div style="text-align:center; padding:50px; color:#aaa;">Loading Institution Records...</div>
</div>

<div id="editor-modal">
  <header>
    <div onclick="closeEditor()" style="font-size:20px; cursor:pointer;">Cancel</div>
    <span style="font-weight: 800; font-size: 14px;">EDIT SYLLABUS</span>
    <div onclick="saveChanges()" style="color: var(--primary); font-weight: 700; cursor:pointer;">Update</div>
  </header>
  <div class="editor-content">
    <input type="hidden" id="edit-id">
    <div class="form-group">
      <label>Syllabus Title</label>
      <input type="text" id="edit-name" class="form-input">
    </div>
    <div class="form-group">
      <label>Subject</label>
      <input type="text" id="edit-subject" class="form-input">
    </div>
    <div class="form-group">
      <label>Content / Outline (JSON String)</label>
      <textarea id="edit-content" class="form-input"></textarea>
    </div>
  </div>
</div>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>

<script>
  const API_URL = "https://fastapi-teachers.onrender.com";
  let allSyllabuses = [];

  // Auto-load on entry
  fetchSyllabuses();

  async function fetchSyllabuses() {
    try {
      const tokenObj = await AppStorage.get("institutionToken");
      const token = tokenObj.value || tokenObj;

      const res = await fetch(`${API_URL}/document/vault-list?type=syllabus`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      allSyllabuses = await res.json();
      renderList(allSyllabuses);
    } catch (e) {
      showNotify("Connection to Vault failed", "red");
    }
  }

  function renderList(data) {
    const container = document.getElementById('syllabus-container');
    container.innerHTML = '';

    if (data.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding:50px; color:#aaa;">No syllabuses found in this institution.</div>';
      return;
    }

    data.forEach(item => {
      const card = document.createElement('div');
      card.className = 'syllabus-card';
      card.innerHTML = `
                <div class="card-top">
                    <span class="sub-tag">${item.subject}</span>
                    <span class="card-meta">By ${item.author_name || 'Admin'}</span>
                </div>
                <div class="card-title">${item.name}</div>
                <div class="targets-row">
                    ${item.targets.map(t => `<span class="target-chip">${t}</span>`).join('')}
                </div>
                <div class="card-actions">
                    <button class="btn-edit" onclick="openEditor('${item.id}')">EDIT</button>
                    <button class="btn-view" onclick="viewFull('${item.id}')">VIEW PDF</button>
                </div>
            `;
      container.appendChild(card);
    });
  }

  function filterSyllabus(query) {
    const filtered = allSyllabuses.filter(s =>
            s.name.toLowerCase().includes(query.toLowerCase()) ||
            s.subject.toLowerCase().includes(query.toLowerCase())
    );
    renderList(filtered);
  }

  function openEditor(id) {
    const item = allSyllabuses.find(s => s.id == id);
    if (!item) return;

    document.getElementById('edit-id').value = item.id;
    document.getElementById('edit-name').value = item.name;
    document.getElementById('edit-subject').value = item.subject;
    document.getElementById('edit-content').value = JSON.stringify(item.content, null, 2);

    document.getElementById('editor-modal').style.display = 'flex';
  }

  function closeEditor() {
    document.getElementById('editor-modal').style.display = 'none';
  }

  async function saveChanges() {
    const id = document.getElementById('edit-id').value;
    const updateData = {
      name: document.getElementById('edit-name').value,
      subject: document.getElementById('edit-subject').value,
      content: JSON.parse(document.getElementById('edit-content').value)
    };

    try {
      const tokenObj = await AppStorage.get("institutionToken");
      const token = tokenObj.value || tokenObj;

      const res = await fetch(`${API_URL}/document/vault-update/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(updateData)
      });

      if (res.ok) {
        showNotify("Syllabus updated successfully!", "green");
        closeEditor();
        fetchSyllabuses(); // Refresh list
      }
    } catch (e) {
      showNotify("Update failed", "red");
    }
  }

  function viewFull(id) {
    // Logic to generate/view PDF or full details
    showNotify("Opening PDF Viewer...", "green");
  }

  function showNotify(msg, colorClass) {
    const bar = document.getElementById('notification-bar');
    bar.innerText = msg;
    bar.className = `bg-${colorClass}`;
    setTimeout(() => bar.className = "", 3000);
  }
</script>
</body>
</html>