<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finance Architect | Institution Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #263238;
            --bg: #f4f7f6;
            --border: #d1d9e0;
            --danger: #ef5350;
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }

        /* Mode Switcher */
        .mode-bar {
            background: white; padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid #eee;
        }
        .mode-btn {
            flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #ddd;
            font-size: 12px; font-weight: 700; cursor: pointer; text-align: center; transition: 0.3s;
        }
        .mode-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        #notification-bar {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; padding: 15px; border-radius: 12px;
            color: white; text-align: center; transition: 0.4s; z-index: 2000; font-weight: 600;
        }
        .bg-red { background: var(--danger); top: 20px !important; }
        .bg-green { background: var(--primary); top: 20px !important; }

        header { background: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .main-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }

        .config-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }

        label { font-size: 11px; font-weight: 700; color: var(--secondary); text-transform: uppercase; margin-bottom: 8px; display: block; }

        input, select {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px;
        }

        .fee-item-row { display: grid; grid-template-columns: 2fr 1fr 40px; gap: 10px; margin-bottom: 10px; }
        .remove-btn { color: var(--danger); font-weight: 800; cursor: pointer; padding-top: 12px; text-align: center; }

        /* Preview Box */
        .voucher-preview {
            background: white; border: 2px solid var(--secondary); border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px;
        }
        .v-type-tag { font-size: 10px; background: #eee; padding: 2px 8px; border-radius: 4px; margin-bottom: 10px; display: inline-block; }
        .v-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
        .total-strip { background: var(--secondary); color: white; padding: 10px; border-radius: 8px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: 700; }

        .btn-add { background: #e8f5e9; color: var(--primary); border: 2px dashed var(--primary); width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-bottom: 20px; }

        .publish-footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 20px; border-top: 1px solid #eee; display: flex; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; flex: 1; padding: 15px; border-radius: 15px; font-weight: 700; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div id="notification-bar"></div>

<div class="mode-bar">
    <div class="mode-btn active" id="btn-student" onclick="setMode('student')">Student Voucher</div>
    <div class="mode-btn" id="btn-staff" onclick="setMode('staff')">Staff Pay Receipt</div>
</div>

<header>
    <div onclick="history.back()" style="font-size:24px; cursor:pointer;">✕</div>
    <h2 id="header-title" style="margin:0; font-size:16px; font-weight:800;">Fee Voucher Architect</h2>
    <div style="width:24px;"></div>
</header>

<div class="main-container">
    <div class="config-card">
        <label id="lbl-target">Target Class / Department</label>
        <select id="target-group" onchange="updatePreview()">
            <option>Grade 10 - Section A</option>
            <option>Grade 9 - All Sections</option>
            <option>Faculty of Science</option>
            <option>Administrative Staff</option>
        </select>

        <label>Billing Month</label>
        <input type="month" id="billing-month" onchange="updatePreview()">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>Issue Date</label><input type="date" id="issue-date" onchange="updatePreview()"></div>
            <div><label id="lbl-date-type">Due Date</label><input type="date" id="due-date" onchange="updatePreview()"></div>
        </div>
    </div>

    <div class="config-card">
        <label id="lbl-heads">Earnings / Charges</label>
        <div id="heads-list">
            <div class="fee-item-row">
                <input type="text" placeholder="e.g. Tuition Fee" class="h-name" oninput="updatePreview()">
                <input type="number" placeholder="Amount" class="h-amount" oninput="updatePreview()">
                <div class="remove-btn" onclick="this.parentElement.remove(); updatePreview();">✕</div>
            </div>
        </div>
        <button class="btn-add" onclick="addHeadRow()">+ Add New Head</button>
    </div>

    <label>Structure Template Preview</label>
    <div class="voucher-preview">
        <span class="v-type-tag" id="v-tag">FEE CHALLAN</span>

        <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--secondary);">
            <div style="font-size: 10px; color: #888; font-weight: 700;">RECIPIENT NAME</div>
            <div style="font-size: 14px; font-weight: 600; color: #333;">[DYNAMIC NAME FIELD]</div>
            <div style="font-size: 10px; color: #aaa;">ID: [AUTO-GENERATED]</div>
        </div>

        <div class="v-row"><span>Month:</span> <b id="pre-month">-</b></div>
        <div class="v-row"><span id="pre-date-lbl">Due Date:</span> <span id="pre-due">-</span></div>

        <hr style="border:none; border-top: 1px dashed #ddd; margin: 15px 0;">
        <div id="pre-items"></div>

        <div class="total-strip">
            <span id="lbl-total">TOTAL PAYABLE</span>
            <span id="pre-total">0.00</span>
        </div>
    </div>
</div>

<div class="publish-footer">
    <button class="btn-main" onclick="processBulk()">Save Structure & Generate All</button>
</div>

<script>
    let mode = 'student';
    const API_URL = "https://fastapi-teachers.onrender.com";

    function setMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + newMode).classList.add('active');

        document.getElementById('header-title').innerText = mode === 'student' ? 'Fee Voucher Architect' : 'Staff Payroll Architect';
        document.getElementById('v-tag').innerText = mode === 'student' ? 'FEE CHALLAN' : 'PAY SLIP';
        document.getElementById('lbl-target').innerText = mode === 'student' ? 'Target Class / Section' : 'Department / Group';
        document.getElementById('lbl-heads').innerText = mode === 'student' ? 'Fee Particulars' : 'Salary Breakdown';
        document.getElementById('lbl-total').innerText = mode === 'student' ? 'TOTAL PAYABLE' : 'NET SALARY';
        document.getElementById('lbl-date-type').innerText = mode === 'student' ? 'Due Date' : 'Pay Date';
        document.getElementById('pre-date-lbl').innerText = mode === 'student' ? 'Due Date:' : 'Pay Date:';
        document.querySelector('.btn-main').innerText = mode === 'student' ? 'Save & Send to Students' : 'Save & Process Payroll';

        updatePreview();
    }

    function addHeadRow() {
        const div = document.createElement('div');
        div.className = 'fee-item-row';
        div.innerHTML = `
            <input type="text" placeholder="${mode === 'student' ? 'Tuition Fee' : 'Basic Salary'}" class="h-name" oninput="updatePreview()">
            <input type="number" placeholder="Amount" class="h-amount" oninput="updatePreview()">
            <div class="remove-btn" onclick="this.parentElement.remove(); updatePreview();">✕</div>
        `;
        document.getElementById('heads-list').appendChild(div);
    }

    function updatePreview() {
        document.getElementById('pre-month').innerText = document.getElementById('billing-month').value || "-";
        document.getElementById('pre-due').innerText = document.getElementById('due-date').value || "-";

        const hNames = document.querySelectorAll('.h-name');
        const hAmounts = document.querySelectorAll('.h-amount');
        const list = document.getElementById('pre-items');
        list.innerHTML = '';

        let total = 0;
        hNames.forEach((n, i) => {
            const amt = parseFloat(hAmounts[i].value) || 0;
            total += amt;
            list.innerHTML += `<div class="v-row"><span>${n.value || 'Item'}</span><span>${amt.toLocaleString()}</span></div>`;
        });

        document.getElementById('pre-total').innerText = total.toLocaleString() + " PKR";
    }

    function showNotify(msg, type) {
        const bar = document.getElementById('notification-bar');
        bar.innerText = msg;
        bar.className = type === 'error' ? 'bg-red' : 'bg-green';
        setTimeout(() => bar.className = "", 3000);
    }

    async function processBulk() {
        const heads = [];
        document.querySelectorAll('.fee-item-row').forEach(row => {
            const name = row.querySelector('.h-name').value.trim();
            const amt = row.querySelector('.h-amount').value.trim();
            if (name && amt) heads.push({ name, amount: parseFloat(amt) });
        });

        if (heads.length === 0) return showNotify("Add at least one head", "error");

        // Get input values
        const target_group = document.getElementById('target-group').value;
        const billing_month = document.getElementById('billing-month').value;
        const issue_date = document.getElementById('issue-date').value;
        const due_date = document.getElementById('due-date').value;

        if(!billing_month || !issue_date || !due_date) return showNotify("Fill all dates", "error");

        const payload = { target_group, billing_month, mode, issue_date, due_date, heads };

        try {
            // REAL APP FIX: Use Capacitor Storage
            const result = await AppStorage.get("institutionToken");
            const token = (result && typeof result === 'object') ? result.value : result;

            if (!token) return showNotify("Session Expired", "error");

            const res = await fetch(`${API_URL}/finance/process-bulk`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                showNotify("Structure Saved Successfully!", "green");
                setTimeout(() => location.reload(), 2000);
            } else {
                const err = await res.json();
                showNotify(err.detail || "Processing failed", "error");
            }
        } catch (err) {
            showNotify("Network Error", "error");
        }
    }
</script>
</body>
</html>