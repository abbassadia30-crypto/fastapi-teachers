<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finance Architect | Professional Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1b5e20; --secondary: #263238; --bg: #f8faf9; --border: #cfd8dc; --danger: #d32f2f; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; color: var(--secondary); }

        /* üèõÔ∏è Notification Box */
        #sign-box { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; padding: 15px; border-radius: 12px; color: white; text-align: center; transition: 0.4s; z-index: 9999; font-weight: 700; display: none; }
        .sign-red { background: var(--danger); display: block !important; top: 20px !important; }
        .sign-green { background: var(--primary); display: block !important; top: 20px !important; }

        header { background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .workspace { flex: 1; overflow-y: auto; padding: 15px; }

        /* Step Tabs */
        .step-bar { display: flex; background: #eceff1; margin: 10px; border-radius: 12px; padding: 5px; }
        .step-tab { flex: 1; text-align: center; padding: 10px; font-size: 10px; font-weight: 800; border-radius: 8px; color: #78909c; }
        .step-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .config-card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); }
        label { font-size: 10px; font-weight: 800; color: #546e7a; text-transform: uppercase; margin-bottom: 5px; display: block; }

        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 13px; box-sizing: border-box; }

        /* Voucher List Tabs */
        .voucher-tabs { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 15px; }
        .v-tab { padding: 8px 15px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 11px; white-space: nowrap; font-weight: 600; cursor: pointer; }
        .v-tab.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .fee-row { display: grid; grid-template-columns: 2fr 1fr 30px; gap: 8px; margin-bottom: 8px; }
        .btn-add-field { background: #e8f5e9; color: var(--primary); border: 2px dashed var(--primary); padding: 10px; border-radius: 10px; font-weight: 700; font-size: 11px; width: 100%; cursor: pointer; }

        .footer { background: white; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn-main { background: var(--primary); color: white; border: none; flex: 2; padding: 16px; border-radius: 15px; font-weight: 700; cursor: pointer; }
        .btn-back { background: #cfd8dc; color: #455a64; border: none; flex: 1; padding: 16px; border-radius: 15px; font-weight: 700; cursor: pointer; display: none; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="sign-box"></div>

<header>
    <div onclick="history.back()" style="font-size:22px;">‚úï</div>
    <span style="font-weight: 900; font-size: 14px; letter-spacing: 1px;">FINANCE ARCHITECT</span>
    <div style="width:22px;"></div>
</header>

<div class="step-bar">
    <div class="step-tab active" id="tab-1">1. SETUP</div>
    <div class="step-tab" id="tab-2">2. DRAFTING</div>
    <div class="step-tab" id="tab-3">3. DEPLOY</div>
</div>

<div class="workspace">
    <div id="view-setup">
        <div class="config-card">
            <label>Transaction Type</label>
            <select id="mode-select" onchange="toggleCustomMode()">
                <option value="student">Student Fee (Bulk)</option>
                <option value="staff">Staff Payroll (Bulk)</option>
                <option value="custom">Manual / One-Off Receipt</option>
            </select>

            <div id="target-container">
                <label id="target-label">Target Class</label>
                <select id="target-group" onchange="checkManualTarget(this.value)">
                    <option value="fetch">-- Loading Sections... --</option>
                    <option value="manual_entry">[+] ENTER MANUALLY</option>
                </select>
                <input type="text" id="manual-target" class="hidden" placeholder="Type Section/Dept Name...">
            </div>

            <label>Billing Period</label>
            <input type="month" id="billing-period">
        </div>

        <div class="config-card" id="base-template-card">
            <label>Base Template (Charges/Earnings)</label>
            <div id="base-heads">
                <div class="fee-row">
                    <input type="text" placeholder="Description" class="h-name">
                    <input type="number" placeholder="Amount" class="h-amount">
                    <div style="color:var(--danger); font-weight:900;" onclick="this.parentElement.remove()">‚úï</div>
                </div>
            </div>
            <button class="btn-add-field" onclick="addHeadRow('base-heads')">+ ADD CHARGE HEAD</button>
        </div>
    </div>

    <div id="view-drafting" class="hidden">
        <div class="voucher-tabs" id="draft-tabs"></div>

        <div class="config-card" id="editor-card">
            <label>Recipient Information</label>
            <div id="recipient-fields">
                <input type="text" id="edit-name" placeholder="Name">
                <input type="text" id="edit-id" placeholder="ID / Roll No">
                <input type="text" id="edit-parent" placeholder="Father Name">
                <input type="text" id="edit-phone" placeholder="Phone">
            </div>

            <label>Voucher Particulars</label>
            <div id="edit-heads"></div>
            <button class="btn-add-field" onclick="addHeadRow('edit-heads')">+ ADD ADJUSTMENT</button>
        </div>
    </div>
</div>

<div class="footer">
    <button class="btn-back" id="btn-back" onclick="changeStep(-1)">BACK</button>
    <button class="btn-main" id="btn-next" onclick="changeStep(1)">PROCEED TO DRAFT</button>
</div>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>

<script>
    const API_URL = "https://fastapi-teachers.onrender.com";
    let step = 1;
    let drafts = [];
    let currentDraftIndex = 0;

    // --- Core Navigation ---
    function showNotify(msg, type) {
        const box = document.getElementById('sign-box');
        box.innerText = msg;
        box.className = type === 'success' ? 'sign-green' : 'sign-red';
        setTimeout(() => box.className = "", 3000);
    }

    async function changeStep(dir) {
        if (dir === 1 && step === 1) await generateDrafts();
        else if (dir === 1 && step === 2) await finalizeDeployment();
        else {
            step += dir;
            updateUI();
        }
    }

    function updateUI() {
        document.getElementById('view-setup').classList.toggle('hidden', step !== 1);
        document.getElementById('view-drafting').classList.toggle('hidden', step !== 2);
        document.getElementById('btn-back').style.display = step > 1 ? 'block' : 'none';
        document.getElementById('btn-next').innerText = step === 1 ? 'PROCEED TO DRAFT' : 'DEPLOY VOUCHERS';

        document.querySelectorAll('.step-tab').forEach((t, i) => {
            t.classList.toggle('active', i + 1 === step);
        });
    }

    // --- Logic 1: Fetching and Targeting ---
    function toggleCustomMode() {
        const mode = document.getElementById('mode-select').value;
        document.getElementById('target-label').innerText = mode === 'staff' ? 'Department' : 'Target Class';
        document.getElementById('base-template-card').classList.toggle('hidden', mode === 'custom');
    }

    function checkManualTarget(val) {
        document.getElementById('manual-target').classList.toggle('hidden', val !== 'manual_entry');
    }

    // --- Logic 2: Generating Drafts ---
    async function generateDrafts() {
        const mode = document.getElementById('mode-select').value;
        const target = document.getElementById('target-group').value;
        const manualTarget = document.getElementById('manual-target').value;
        const billing = document.getElementById('billing-period').value;

        if (!billing) return showNotify("Please select a billing period", "error");

        // Prepare Base Heads
        const baseHeads = Array.from(document.querySelectorAll('#base-heads .fee-row')).map(r => ({
            name: r.querySelector('.h-name').value,
            amount: parseFloat(r.querySelector('.h-amount').value) || 0
        }));

        if (mode === 'custom') {
            drafts = [{ name: "New Entry", id: "", parent: "", phone: "", heads: [] }];
        } else {
            showNotify("Fetching Members...", "success");
            try {
                const tokenRes = await AppStorage.get("institutionToken");
                const token = tokenRes.value || tokenRes;
                const endpoint = mode === 'student' ? `/institution/students/${target}` : `/institution/staff/${target}`;

                const res = await fetch(`${API_URL}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const members = await res.json();

                drafts = members.map(m => ({
                    db_id: m.id,
                    name: m.name,
                    id: m.roll_no || m.staff_id || "",
                    parent: m.father_name || "",
                    phone: m.phone || "",
                    heads: JSON.parse(JSON.stringify(baseHeads)) // Deep copy
                }));
            } catch (e) {
                return showNotify("Connection Failed", "error");
            }
        }

        step = 2;
        renderTabs();
        selectDraft(0);
        updateUI();
    }

    // --- Logic 3: Editing Drafts ---
    function renderTabs() {
        const container = document.getElementById('draft-tabs');
        container.innerHTML = drafts.map((d, i) => `
            <div class="v-tab ${i === 0 ? 'selected' : ''}" onclick="selectDraft(${i})" id="tab-v-${i}">
                ${d.name || 'Unnamed'}
            </div>
        `).join('');
    }

    function selectDraft(index) {
        // Save current draft before switching
        saveCurrentToMemory();

        currentDraftIndex = index;
        const d = drafts[index];

        document.querySelectorAll('.v-tab').forEach(t => t.classList.remove('selected'));
        document.getElementById(`tab-v-${index}`).classList.add('selected');

        document.getElementById('edit-name').value = d.name;
        document.getElementById('edit-id').value = d.id;
        document.getElementById('edit-parent').value = d.parent;
        document.getElementById('edit-phone').value = d.phone;

        const headsContainer = document.getElementById('edit-heads');
        headsContainer.innerHTML = d.heads.map(h => `
            <div class="fee-row">
                <input type="text" value="${h.name}" class="h-name">
                <input type="number" value="${h.amount}" class="h-amount">
                <div style="color:var(--danger); font-weight:900;" onclick="this.parentElement.remove()">‚úï</div>
            </div>
        `).join('');
    }

    function saveCurrentToMemory() {
        if (drafts.length === 0) return;
        const d = drafts[currentDraftIndex];
        d.name = document.getElementById('edit-name').value;
        d.id = document.getElementById('edit-id').value;
        d.parent = document.getElementById('edit-parent').value;
        d.phone = document.getElementById('edit-phone').value;

        d.heads = Array.from(document.querySelectorAll('#edit-heads .fee-row')).map(r => ({
            name: r.querySelector('.h-name').value,
            amount: parseFloat(r.querySelector('.h-amount').value) || 0
        }));

        document.getElementById(`tab-v-${currentDraftIndex}`).innerText = d.name;
    }

    function addHeadRow(containerId) {
        const div = document.createElement('div');
        div.className = 'fee-row';
        div.innerHTML = `
            <input type="text" placeholder="Description" class="h-name">
            <input type="number" placeholder="Amount" class="h-amount">
            <div style="color:var(--danger); font-weight:900;" onclick="this.parentElement.remove()">‚úï</div>
        `;
        document.getElementById(containerId).appendChild(div);
    }

    async function finalizeDeployment() {
        saveCurrentToMemory();
        const btn = document.getElementById('btn-next');
        btn.disabled = true;
        btn.innerText = "DEPLOYING...";

        try {
            const tokenRes = await AppStorage.get("institutionToken");
            const token = tokenRes.value || tokenRes;

            const res = await fetch(`${API_URL}/document/finance/deploy-bulk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    billing_period: document.getElementById('billing-period').value,
                    vouchers: drafts
                })
            });

            if (res.ok) {
                showNotify("All Vouchers Processed!", "success");
                setTimeout(() => location.reload(), 2000);
            } else {
                throw new Error();
            }
        } catch (e) {
            showNotify("Deployment Failed", "error");
            btn.disabled = false;
            btn.innerText = "DEPLOY VOUCHERS";
        }
    }
</script>

</body>
</html>