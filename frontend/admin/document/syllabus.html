<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Syllabus Architect | Institution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0288d1;
            --secondary: #263238;
            --bg: #f0f2f5;
            --success: #2e7d32;
            --danger: #d32f2f;
            --muted: #78909c;
            --border: #e0e0e0;
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); padding-bottom: 120px; color: var(--secondary); overflow-x: hidden; }

        #sign-box { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 85%; padding: 15px; border-radius: 12px; color: white; text-align: center; z-index: 6000; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .sign-red { background: var(--danger); }
        .sign-green { background: var(--success); }

        #name-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center; }

        header { background: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }

        .main-container { padding: 20px; max-width: 600px; margin: 0 auto; }

        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        label { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; }

        .input-wrapper { background: #f9f9f9; padding: 12px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 15px; }
        .field-row { display: flex; align-items: center; border-bottom: 2px solid #ddd; margin-bottom: 10px; transition: 0.3s; }
        .field-row:focus-within { border-bottom-color: var(--primary); }

        .input-group { flex: 1; }
        .micro-label { font-size: 9px; color: var(--primary); font-weight: 800; display: block; }

        input { width: 100%; border: none; outline: none; background: transparent; padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--secondary); font-family: inherit; }

        .manual-add { color: var(--primary); font-size: 24px; font-weight: 800; padding: 0 10px; cursor: pointer; }

        .tag-box { display: flex; flex-wrap: wrap; gap: 6px; min-height: 20px; }
        .tag { background: var(--secondary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .tag span { cursor: pointer; opacity: 0.6; }

        .book-section { background: white; border-radius: 20px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .book-header { background: #f8f9fa; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .section-title-input { font-weight: 800; border: none; background: transparent; font-size: 14px; flex: 1; }

        .chapter-row { padding: 20px; border-bottom: 1px solid #f0f0f0; }
        .chap-name { font-weight: 600; border: none; border-bottom: 1px solid #eee; width: 80%; margin-bottom: 10px; }

        .topic-pill { background: #e3f2fd; color: var(--primary); padding: 6px 14px; border-radius: 20px; font-size: 11px; display: inline-flex; align-items: center; margin: 4px; font-weight: 700; }
        .topic-pill span { margin-left: 8px; font-size: 14px; cursor: pointer; }

        .btn-main { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: var(--primary); color: white; border: none; padding: 20px; border-radius: 18px; font-weight: 800; font-size: 16px; z-index: 2000; box-shadow: 0 8px 20px rgba(2,136,209,0.3); }
        .gen-btn { background: var(--secondary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 700; margin-top: 10px; }
        .add-btn { width: 100%; padding: 14px; border: 2px dashed #ddd; background: none; color: var(--muted); border-radius: 12px; margin-top: 10px; font-weight: 600; }
    </style>
</head>
<body>

<div id="sign-box"></div>

<div id="name-modal">
    <div class="modal-card">
        <h3 style="margin-top:0;">Name this Syllabus</h3>
        <input type="text" id="doc-name-input" placeholder="e.g. Annual Syllabus 2026" style="border-bottom: 2px solid var(--primary); margin: 20px 0; text-align: center; font-size: 18px;">
        <div style="display:flex; gap:10px;">
            <button class="gen-btn" style="background:#eee; color:#333;" onclick="toggleModal(false)">Cancel</button>
            <button class="gen-btn" style="background:var(--success); flex:2;" onclick="confirmDeployment()">Confirm & Deploy</button>
        </div>
    </div>
</div>

<header>
    <div onclick='history.back();' style="font-size:24px; font-weight:800; cursor:pointer;">✕</div>
    <h2 style="margin:0; font-size:17px; font-weight: 800;">Syllabus Architect</h2>
    <div style="width:24px;"></div>
</header>

<div class="main-container">
    <div class="card">
        <label>Architect Configuration</label>
        <div class="input-wrapper">
            <div class="field-row">
                <div class="input-group">
                    <span class="micro-label">Target Classes</span>
                    <input type="text" id="class-input" placeholder="Enter Class Name" onkeydown="if(event.key==='Enter') addListTag('class')">
                </div>
                <div class="manual-add" onclick="addListTag('class')">+</div>
            </div>
            <div class="tag-box" id="class-tags"></div>
        </div>

        <div class="input-wrapper">
            <div class="field-row">
                <div class="input-group">
                    <span class="micro-label">Target Subjects</span>
                    <input type="text" id="subject-input" placeholder="Enter Subject Name" onkeydown="if(event.key==='Enter') addListTag('subject')">
                </div>
                <div class="manual-add" onclick="addListTag('subject')">+</div>
            </div>
            <div class="tag-box" id="subject-tags"></div>
        </div>
        <button class="gen-btn" onclick="generateArchitectSections()">Build Architect Workspace</button>
    </div>

    <div id="syllabus-content"></div>
    <button class="add-btn" onclick="addBook('')" style="border-style: solid; border-width: 1px;">+ Add Empty Manual Section</button>
</div>

<button class="btn-main" onclick="toggleModal(true)">Deploy to Institution Vault</button>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>
<script>
    const API_BASE = "https://fastapi-teachers.onrender.com";
    let isEditMode = false;
    let currentEditId = null;

    function showNotify(msg, type) {
        const box = document.getElementById('sign-box');
        box.innerText = msg;
        box.className = type === 'success' ? 'sign-green' : 'sign-red';
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }

    function toggleModal(show) { document.getElementById('name-modal').style.display = show ? 'flex' : 'none'; }

    function addListTag(type) {
        const input = document.getElementById(`${type}-input`);
        const val = input.value.trim();
        if (!val) return;
        injectTag(type, val);
        input.value = "";
    }

    function injectTag(type, val) {
        const container = document.getElementById(`${type}-tags`);
        const existing = Array.from(container.querySelectorAll('.tag')).map(t => t.dataset.val);
        if (existing.includes(val)) return;
        const tag = document.createElement('div');
        tag.className = 'tag'; tag.dataset.val = val;
        tag.innerHTML = `${val} <span onclick="this.parentElement.remove()">✕</span>`;
        container.appendChild(tag);
    }

    function addTopic(e, input) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent form submission
            const topicText = input.value.trim();
            if (topicText) {
                const pill = document.createElement('div');
                pill.className = 'topic-pill';
                pill.dataset.topic = topicText; // Store the raw text
                pill.innerHTML = `${topicText} <span onclick="this.parentElement.remove()">✕</span>`;
                input.previousElementSibling.appendChild(pill);
                input.value = '';
            }
        }
    }

    function addChapter(btn) {
        const div = document.createElement('div');
        div.className = 'chapter-row';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <input type="text" class="chap-name" placeholder="Chapter Name">
                <span onclick="this.parentElement.parentElement.remove()" style="color:var(--danger); font-size:11px; font-weight:700;">DEL</span>
            </div>
            <div class="topic-list"></div>
            <input type="text" placeholder="+ topic" onkeydown="addTopic(event, this)" style="font-size:12px; color:var(--primary); border:none;">
        `;
        btn.before(div);
    }

    function addBook(title = "") {
        const container = document.getElementById('syllabus-content');
        const section = document.createElement('div');
        section.className = 'book-section';
        section.innerHTML = `
            <div class="book-header">
                <input type="text" class="section-title-input" value="${title}" placeholder="Section Title">
                <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:var(--danger);">✕</button>
            </div>
            <div class="chapter-row">
                <input type="text" class="chap-name" placeholder="Chapter Name">
                <div class="topic-list"></div>
                <input type="text" placeholder="+ topic" onkeydown="addTopic(event, this)" style="font-size:12px; color:var(--primary); border:none;">
            </div>
            <button class="add-btn" style="border:none; color:var(--primary); background:#e1f5fe; border-radius:0;" onclick="addChapter(this)">+ Add Chapter</button>
        `;
        container.appendChild(section);
    }

    function generateArchitectSections() {
        const classes = Array.from(document.querySelectorAll('#class-tags .tag')).map(t => t.dataset.val);
        const subjects = Array.from(document.querySelectorAll('#subject-tags .tag')).map(t => t.dataset.val);
        if (!classes.length || !subjects.length) return showNotify("Add class and subject tags", "error");
        classes.forEach(c => subjects.forEach(s => addBook(`${c} - ${s}`)));
    }

    async function initArchitect() {
        const params = new URLSearchParams(window.location.search);
        currentEditId = params.get('editId');
        if (!currentEditId) return;

        isEditMode = true;
        document.querySelector('h2').innerText = "Edit Syllabus";
        document.querySelector('.btn-main').innerText = "Update Vault Record";

        const resToken = await AppStorage.get('institutionToken');
        const token = resToken.value || resToken;

        try {
            const res = await fetch(`${API_BASE}/central_vault/vault/list`, { headers: {'Authorization': `Bearer ${token}`} });
            const docs = await res.json();
            const doc = docs.find(d => d.id == currentEditId);
            if (doc) {
                document.getElementById('doc-name-input').value = doc.name;
                doc.targets.forEach(t => injectTag('class', t));
                doc.subject.split(',').forEach(s => injectTag('subject', s.trim()));
                document.getElementById('syllabus-content').innerHTML = "";
                doc.content.forEach(sec => {
                    addBook(sec.title);
                    const lastSec = document.getElementById('syllabus-content').lastElementChild;
                    lastSec.querySelector('.chapter-row').remove(); // Clear default chapter
                    sec.chapters.forEach(ch => {
                        const div = document.createElement('div');
                        div.className = 'chapter-row';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <input type="text" class="chap-name" value="${ch.name}">
                                <span onclick="this.parentElement.parentElement.remove()" style="color:var(--danger); font-size:11px; font-weight:700;">DEL</span>
                            </div>
                            <div class="topic-list">${ch.topics.map(t => `<div class="topic-pill" data-topic="${t}">${t} <span onclick="this.parentElement.remove()">✕</span></div>`).join('')}</div>
                            <input type="text" placeholder="+ topic" onkeydown="addTopic(event, this)" style="font-size:12px; color:var(--primary); border:none;">`;
                        lastSec.querySelector('.add-btn').before(div);
                    });
                });
            }
        } catch (e) { showNotify("Load Error", "error"); }
    }

    async function confirmDeployment() {
        const docName = document.getElementById('doc-name-input').value.trim();
        if (!docName) return showNotify("Provide a name", "error");

        const resToken = await AppStorage.get('institutionToken');
        const token = resToken.value || resToken;

        const payload = {
            name: docName,
            subject: Array.from(document.querySelectorAll('#subject-tags .tag')).map(t => t.dataset.val).join(', '),
            targets: Array.from(document.querySelectorAll('#class-tags .tag')).map(t => t.dataset.val),
            doc_type: "syllabus",
            content: Array.from(document.querySelectorAll('.book-section')).map(sec => ({
                title: sec.querySelector('.section-title-input').value,
                chapters: Array.from(sec.querySelectorAll('.chapter-row')).map(chap => ({
                    name: chap.querySelector('.chap-name').value,
                    // CORRECTED: Directly read the data attribute for reliable extraction.
                    topics: Array.from(chap.querySelectorAll('.topic-pill')).map(p => p.dataset.topic)
                }))
            }))
        };

        const url = isEditMode ? `${API_BASE}/central_vault/vault/update/${currentEditId}` : `${API_BASE}/document/vault/upload`;
        try {
            const res = await fetch(url, {
                method: isEditMode ? 'PUT' : 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                showNotify(isEditMode ? "Vault Updated!" : "Syllabus Created!", "success");
                setTimeout(() => location.href="central_vault/syllabus.html", 1500);
            }
        } catch (e) { showNotify("Server Sync Failed", "error"); }
    }

    initArchitect();
</script>
</body>
</html>
