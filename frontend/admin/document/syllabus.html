<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Syllabus Architect | Institution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0288d1;
            --secondary: #263238;
            --bg: #f0f2f5;
            --success: #2e7d32;
            --danger: #d32f2f;
            --muted: #78909c;
            --border: #e0e0e0;
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); padding-bottom: 120px; color: var(--secondary); overflow-x: hidden; }

        /* Notification Box */
        #sign-box { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 85%; padding: 15px; border-radius: 12px; color: white; text-align: center; z-index: 4000; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .sign-red { background: var(--danger); }
        .sign-green { background: var(--success); }

        /* Modal for Doc Name */
        #name-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center; }

        header { background: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }

        .main-container { padding: 20px; max-width: 600px; margin: 0 auto; }

        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        label { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; }

        /* Android Optimized Input Wrapper */
        .input-wrapper { background: #f9f9f9; padding: 12px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 15px; }
        .field-row { display: flex; align-items: center; border-bottom: 2px solid #ddd; margin-bottom: 10px; transition: 0.3s; }
        .field-row:focus-within { border-bottom-color: var(--primary); }

        .input-group { flex: 1; }
        .micro-label { font-size: 9px; color: var(--primary); font-weight: 800; display: block; }

        input { width: 100%; border: none; outline: none; background: transparent; padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--secondary); font-family: inherit; }

        .manual-add { color: var(--primary); font-size: 24px; font-weight: 800; padding: 0 10px; cursor: pointer; }

        .tag-box { display: flex; flex-wrap: wrap; gap: 6px; min-height: 20px; }
        .tag { background: var(--secondary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .tag span { cursor: pointer; opacity: 0.6; }

        /* Syllabus Section */
        .book-section { background: white; border-radius: 20px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .book-header { background: #f8f9fa; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .chapter-row { padding: 20px; border-bottom: 1px solid #f0f0f0; }

        .topic-pill { background: #e3f2fd; color: var(--primary); padding: 6px 14px; border-radius: 20px; font-size: 11px; display: inline-flex; align-items: center; margin: 4px; font-weight: 700; }

        .btn-main { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: var(--primary); color: white; border: none; padding: 20px; border-radius: 18px; font-weight: 800; font-size: 16px; z-index: 2000; box-shadow: 0 8px 20px rgba(2,136,209,0.3); }
        .gen-btn { background: var(--secondary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 700; margin-top: 10px; }
        .add-btn { width: 100%; padding: 14px; border: 2px dashed #ddd; background: none; color: var(--muted); border-radius: 12px; margin-top: 10px; font-weight: 600; }
    </style>
</head>
<body>

<div id="sign-box"></div>

<div id="name-modal">
    <div class="modal-card">
        <h3 style="margin-top:0;">Name this Syllabus</h3>
        <p style="font-size:12px; color:var(--muted);">This is how it will appear in the institution collection.</p>
        <input type="text" id="doc-name-input" placeholder="e.g. Annual Syllabus 2026" style="border-bottom: 2px solid var(--primary); margin: 20px 0; text-align: center; font-size: 18px;">
        <div style="display:flex; gap:10px;">
            <button class="gen-btn" style="background:#eee; color:#333;" onclick="toggleModal(false)">Cancel</button>
            <button class="gen-btn" style="background:var(--success); flex:2;" onclick="confirmDeployment()">Confirm & Deploy</button>
        </div>
    </div>
</div>

<header>
    <div onclick="history.back()" style="font-size:24px; font-weight:800; cursor:pointer;">✕</div>
    <h2 style="margin:0; font-size:17px; font-weight: 800;">Syllabus Architect</h2>
    <div style="width:24px;"></div>
</header>

<div class="main-container">
    <div class="card">
        <label>Architect Configuration</label>

        <div class="input-wrapper">
            <div class="field-row">
                <div class="input-group">
                    <span class="micro-label">Target Classes</span>
                    <input type="text" id="class-input" placeholder="Enter Class Name" enterkeyhint="done" onkeydown="if(event.key==='Enter') addListTag('class')">
                </div>
                <div class="manual-add" onclick="addListTag('class')">+</div>
            </div>
            <div class="tag-box" id="class-tags"></div>
        </div>

        <div class="input-wrapper">
            <div class="field-row">
                <div class="input-group">
                    <span class="micro-label">Target Subjects</span>
                    <input type="text" id="subject-input" placeholder="Enter Subject Name" enterkeyhint="done" onkeydown="if(event.key==='Enter') addListTag('subject')">
                </div>
                <div class="manual-add" onclick="addListTag('subject')">+</div>
            </div>
            <div class="tag-box" id="subject-tags"></div>
        </div>

        <button class="gen-btn" onclick="generateArchitectSections()">Build Architect Workspace</button>
    </div>

    <div id="syllabus-content"></div>

    <button class="add-btn" onclick="addBook('')" style="border-style: solid; border-width: 1px;">+ Add Empty Manual Section</button>
</div>

<button class="btn-main" onclick="toggleModal(true)">Deploy to Institution Vault</button>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>
<script>
    const API_BASE = "https://fastapi-teachers.onrender.com";

    function showNotify(msg, type) {
        const box = document.getElementById('sign-box');
        box.innerText = msg;
        box.className = type === 'success' ? 'sign-green' : 'sign-red';
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }

    function toggleModal(show) {
        document.getElementById('name-modal').style.display = show ? 'flex' : 'none';
    }

    // --- Tag Logic ---
    function addListTag(type) {
        const input = document.getElementById(`${type}-input`);
        const val = input.value.trim();
        if (!val) return;

        const container = document.getElementById(`${type}-tags`);
        const existing = Array.from(container.querySelectorAll('.tag')).map(t => t.dataset.val);
        if (existing.includes(val)) return showNotify("Already added", "error");

        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.dataset.val = val;
        tag.innerHTML = `${val} <span onclick="this.parentElement.remove()">✕</span>`;
        container.appendChild(tag);

        input.value = "";
        input.focus();
    }

    function generateArchitectSections() {
        const classes = Array.from(document.querySelectorAll('#class-tags .tag')).map(t => t.dataset.val);
        const subjects = Array.from(document.querySelectorAll('#subject-tags .tag')).map(t => t.dataset.val);

        if (classes.length === 0 || subjects.length === 0) {
            return showNotify("Need at least one Class and Subject", "error");
        }

        classes.forEach(c => {
            subjects.forEach(s => {
                const combined = `${c} - ${s}`;
                const existingHeaders = Array.from(document.querySelectorAll('.section-title-input')).map(i => i.value);
                if (!existingHeaders.includes(combined)) addBook(combined);
            });
        });
        showNotify("Workspace Ready", "success");
    }

    // --- Dynamic Section Helpers ---
    function addTopic(e, input) {
        if (e.key === 'Enter' && input.value.trim() !== "") {
            const pill = document.createElement('div');
            pill.className = 'topic-pill';
            pill.innerHTML = `${input.value.trim()} <span onclick="this.parentElement.remove()">✕</span>`;
            input.previousElementSibling.appendChild(pill);
            input.value = "";
            e.preventDefault();
        }
    }

    function addChapter(btn) {
        const div = document.createElement('div');
        div.className = 'chapter-row';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <input type="text" class="chap-name" placeholder="Chapter Name" style="font-weight:600; border:none; border-bottom:1px solid #eee; width:80%;">
                <span onclick="this.parentElement.parentElement.remove()" style="color:var(--danger); font-size:11px; font-weight:700;">DEL</span>
            </div>
            <div class="topic-list"></div>
            <input type="text" placeholder="+ Add topic" onkeydown="addTopic(event, this)" style="font-size:12px; color:var(--primary); border:none;">
        `;
        btn.before(div);
    }

    function addBook(title = "") {
        const container = document.getElementById('syllabus-content');
        const section = document.createElement('div');
        section.className = 'book-section';
        section.innerHTML = `
            <div class="book-header">
                <input type="text" class="section-title-input" value="${title}" placeholder="Section Title" style="font-weight:800; border:none; background:transparent; flex:1;">
                <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:var(--danger); font-size:18px;">✕</button>
            </div>
            <div class="chapter-row">
                <input type="text" class="chap-name" placeholder="Chapter Name" style="font-weight:600; border:none; border-bottom:1px solid #eee; width:80%;">
                <div class="topic-list"></div>
                <input type="text" placeholder="+ Add topic" onkeydown="addTopic(event, this)" style="font-size:12px; color:var(--primary); border:none;">
            </div>
            <button class="add-btn" style="border:none; color:var(--primary); background:#e1f5fe; border-radius:0; padding:12px; font-size:11px;" onclick="addChapter(this)">+ Add Chapter</button>
        `;
        container.appendChild(section);
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- Final Data Sync ---
    // --- Final Data Sync ---
    async function confirmDeployment() {
        const docName = document.getElementById('doc-name-input').value.trim();
        if (!docName) return showNotify("Please provide a name", "error");

        const btn = document.querySelector('.btn-main');

        // Correctly handle Token retrieval from AppStorage (Capacitor/Mobile context)
        const storageResult = await AppStorage.get('institutionToken');
        const token = (storageResult && typeof storageResult === 'object') ? storageResult.value : storageResult;

        const sections = document.querySelectorAll('.book-section');
        if (sections.length === 0) return showNotify("Workspace is empty", "error");

        // UI Feedback
        toggleModal(false);
        btn.disabled = true;
        btn.innerText = "Processing Vault Sync...";

        // Extract Data from Architect Workspace
        const syllabusData = Array.from(sections).map(sec => ({
            title: sec.querySelector('.section-title-input').value || "Manual Section",
            chapters: Array.from(sec.querySelectorAll('.chapter-row')).map(chap => ({
                name: chap.querySelector('.chap-name').value || "General Chapter",
                topics: Array.from(chap.querySelectorAll('.topic-pill')).map(p => p.innerText.replace('✕', '').trim())
            }))
        }));

        // --- SCHEME ALIGNMENT FIXES ---
        // 1. Get classes for 'targets'
        // 2. Get subjects for 'subject' field
        const targetClasses = Array.from(document.querySelectorAll('#class-tags .tag')).map(t => t.dataset.val);
        const subjectList = Array.from(document.querySelectorAll('#subject-tags .tag')).map(t => t.dataset.val);

        const payload = {
            name: docName,
            subject: subjectList.join(', ') || "General", // Backend expects string
            targets: targetClasses,                       // Backend expects List[str]
            doc_type: "syllabus",
            content: syllabusData
        };

        try {
            const response = await fetch(`${API_BASE}/document/vault/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showNotify("Deployed to Institution Vault!", "success");
                setTimeout(() => history.back(), 2000);
            } else {
                const errData = await response.json();
                console.error("Server Validation Error:", errData);
                showNotify("Sync failed: Check data format", "error");
            }
        } catch (error) {
            console.error("Network Error:", error);
            showNotify("Institution server unreachable", "error");
        } finally {
            btn.disabled = false;
            btn.innerText = "Deploy to Institution Vault";
        }
    }
</script>
</body>
</html>