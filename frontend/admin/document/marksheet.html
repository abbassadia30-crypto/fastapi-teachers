<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marksheet Architect | Institution Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #fb8c00;
      --secondary: #263238;
      --bg: #f8fafc;
      --border: #e2e8f0;
      --success: #4caf50;
      --danger: #f44336;
    }

    body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* üèõÔ∏è Notification Box */
    #notification-bar {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; padding: 15px; border-radius: 12px;
      color: white; text-align: center; transition: 0.4s; z-index: 5000; font-weight: 700;
    }
    .bg-red { background: var(--danger) !important; top: 20px !important; }
    .bg-green { background: var(--success) !important; top: 20px !important; }

    header { background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
    .workspace { flex: 1; overflow-y: auto; padding: 15px; }

    .config-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
    label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }

    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }

    /* üè∑Ô∏è Tag System Styling */
    .tag-container { display: flex; flex-wrap: wrap; gap: 5px; background: #fff; border: 1px solid var(--border); padding: 8px; border-radius: 10px; margin-bottom: 12px; min-height: 45px; align-items: center; }
    .pass-tag { background: var(--secondary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; display: flex; align-items: center; gap: 5px; font-weight: 600; }
    .tag-close { color: #ffab91; cursor: pointer; font-size: 14px; }
    #tag-input { border: none; outline: none; flex: 1; min-width: 60px; font-size: 13px; margin: 0; padding: 5px; }

    .subject-row { display: grid; grid-template-columns: 2.5fr 1fr 40px; gap: 10px; margin-bottom: 10px; }
    .remove-btn { color: var(--danger); font-weight: 900; cursor: pointer; text-align: center; line-height: 40px; }

    /* üìä Gradebook Table */
    .table-wrapper { overflow-x: auto; background: white; border-radius: 12px; border: 1px solid var(--border); }
    .gb-table { width: 100%; border-collapse: collapse; min-width: 500px; }
    .gb-table th { background: #f1f5f9; padding: 12px; font-size: 10px; color: #475569; text-align: left; border-bottom: 2px solid #e2e8f0; }
    .gb-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }
    .obt-input { width: 60px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-weight: bold; }

    .footer { background: white; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
    .btn-main { background: var(--primary); color: white; border: none; flex: 1; padding: 16px; border-radius: 15px; font-weight: 700; cursor: pointer; }
    .btn-back { background: #eee; color: #333; border: none; padding: 16px; border-radius: 15px; font-weight: 700; cursor: pointer; display: none; }
    .btn-manual { border: 2px dashed var(--primary); background: #fff8f0; color: var(--primary); width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; margin-bottom: 15px; cursor: pointer; }

    .hidden { display: none; }
  </style>
</head>
<body>

<div id="notification-bar"></div>

<header>
  <div onclick="history.back()" style="font-size:22px; cursor:pointer;">‚úï</div>
  <span style="font-weight: 800; font-size: 14px;">MARKSHEET ARCHITECT</span>
  <div style="width:22px;"></div>
</header>

<div class="workspace">
  <div id="step1-view">
    <div class="config-card">
      <label>Exam Title</label>
      <input type="text" id="exam-title" placeholder="e.g. Annual Exams 2026">

      <label>Target Institution Section</label>
      <select id="class-select">
        <option value="">Select Section</option>
        <option value="manual_opt">[+] Manual/Custom Entry</option>
      </select>

      <label>Passing Marks Logic (Type Number + Enter)</label>
      <div class="tag-container" id="tag-box" onclick="document.getElementById('tag-input').focus()">
        <div id="tag-list" style="display:contents;"></div>
        <input type="number" id="tag-input" placeholder="Add Passing Mark..." inputmode="numeric">
      </div>
      <p style="font-size: 9px; color: #888; margin-top: -8px;">Tags apply sequentially to subjects below.</p>
    </div>

    <div class="config-card">
      <label>Subjects & Weightage</label>
      <div id="subject-config-list">
        <div class="subject-row">
          <input type="text" placeholder="Subject Name" class="s-name">
          <input type="number" placeholder="Max Marks" class="s-max">
          <div class="remove-btn" onclick="this.parentElement.remove()">‚úï</div>
        </div>
      </div>
      <button onclick="addSubjectRow()" style="width:100%; padding:10px; border:1px dashed var(--primary); background:none; color:var(--primary); font-weight:700; border-radius:10px; font-size:11px;">+ ADD SUBJECT</button>
    </div>
  </div>

  <div id="step2-view" class="hidden">
    <button id="btn-manual-add" class="btn-manual hidden" onclick="addNewManualRow()">+ ADD BLANK STUDENT ROW</button>
    <div class="table-wrapper">
      <table class="gb-table">
        <thead>
        <tr id="gb-header">
          <th>Student Detail</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody id="student-marks-body"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="footer">
  <button class="btn-back" id="btn-back" onclick="toggleStep(1)">BACK</button>
  <button class="btn-main" id="btn-action" onclick="handleAction()">FETCH & START ENTRY</button>
</div>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>

<script>
  let step = 1;
  let subjects = [];
  let passingMarks = [];
  const API_URL = "https://fastapi-teachers.onrender.com";

  // --- üè∑Ô∏è Tag System Logic (Android Optimized) ---
  const tagInput = document.getElementById('tag-input');
  tagInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addTag(this.value);
    }
  });

  function addTag(val) {
    if (!val || val < 0) return;
    passingMarks.push(parseFloat(val));
    renderTags();
    tagInput.value = '';
  }

  function renderTags() {
    const list = document.getElementById('tag-list');
    list.innerHTML = passingMarks.map((m, i) => `
      <div class="pass-tag">
        ${m} <span class="tag-close" onclick="removeTag(${i})">√ó</span>
      </div>
    `).join('');
  }

  function removeTag(i) {
    passingMarks.splice(i, 1);
    renderTags();
  }

  // --- üèõÔ∏è Core App Logic ---
  function addSubjectRow() {
    const div = document.createElement('div');
    div.className = 'subject-row';
    div.innerHTML = `
      <input type="text" placeholder="Subject Name" class="s-name">
      <input type="number" placeholder="Max Marks" class="s-max">
      <div class="remove-btn" onclick="this.parentElement.remove()">‚úï</div>
    `;
    document.getElementById('subject-config-list').appendChild(div);
  }

  async function handleAction() {
    if (step === 1) await startDrafting();
    else await deployResults();
  }

  async function startDrafting() {
    const classId = document.getElementById('class-select').value;
    const exam = document.getElementById('exam-title').value;

    if (!exam || !classId) return showNotify("Fill Exam Title and Section", "error");
    if (passingMarks.length === 0) return showNotify("Add at least one Passing Mark tag", "error");

    subjects = [];
    document.querySelectorAll('.subject-row').forEach(row => {
      const name = row.querySelector('.s-name').value;
      const max = row.querySelector('.s-max').value;
      if (name && max) subjects.push({ name, max: parseFloat(max) });
    });

    if (subjects.length === 0) return showNotify("Define subjects first", "error");

    if (classId === 'manual_opt') {
      document.getElementById('btn-manual-add').classList.remove('hidden');
      buildTable([]);
      toggleStep(2);
    } else {
      document.getElementById('btn-manual-add').classList.add('hidden');
      showNotify("Syncing with Institution DB...", "green");
      try {
        const res = await fetch(`${API_URL}/institution/students/${classId}`);
        const students = await res.json();
        buildTable(students);
        toggleStep(2);
      } catch (e) { showNotify("Connection Error", "error"); }
    }
  }

  function buildTable(students) {
    const header = document.getElementById('gb-header');
    header.innerHTML = '<th>Student Detail</th>';
    subjects.forEach((s, i) => {
      // Map passing marks to subjects. If more subjects than tags, use last tag.
      const pm = passingMarks[i] !== undefined ? passingMarks[i] : passingMarks[passingMarks.length - 1];
      header.innerHTML += `<th>${s.name}<br><span style="font-size:8px; color:var(--primary)">PASS: ${pm}</span></th>`;
    });
    header.innerHTML += '<th>Status</th>';

    const body = document.getElementById('student-marks-body');
    body.innerHTML = '';
    students.forEach(s => injectRow(s.id, s.name, s.father_name, true));
  }

  function addNewManualRow() {
    injectRow(Date.now(), "", "", false);
  }

  function injectRow(id, name, father, isRegistered) {
    const body = document.getElementById('student-marks-body');
    const row = document.createElement('tr');
    row.dataset.stuId = id;

    let rowHtml = `<td>
      ${isRegistered ? `<b>${name}</b><br><small>s/o ${father}</small>` :
            `<input type="text" placeholder="Student Name" class="m-name" style="width:90%; border:none; border-bottom:1px solid #eee; margin-bottom:4px;">
       <input type="text" placeholder="Father Name" class="m-father" style="width:90%; border:none; font-size:10px;">`}
    </td>`;

    subjects.forEach((_, idx) => {
      rowHtml += `<td><input type="number" class="obt-input" data-sub-idx="${idx}" oninput="calculateRow(this)"></td>`;
    });

    rowHtml += `<td id="status-${id}" style="font-weight:bold; color:var(--success);">PASS</td>`;
    row.innerHTML = rowHtml;
    body.appendChild(row);
  }

  function calculateRow(input) {
    const row = input.closest('tr');
    const stuId = row.dataset.stuId;
    const inputs = row.querySelectorAll('.obt-input');
    let isOverallFail = false;

    inputs.forEach((inp, i) => {
      const obt = parseFloat(inp.value) || 0;
      // Get the specific passing mark tag for this column
      const pm = passingMarks[i] !== undefined ? passingMarks[i] : passingMarks[passingMarks.length - 1];

      if (obt < pm) isOverallFail = true;
    });

    const statusCell = document.getElementById(`status-${stuId}`);
    statusCell.innerText = isOverallFail ? "FAIL" : "PASS";
    statusCell.style.color = isOverallFail ? "var(--danger)" : "var(--success)";
  }

  function toggleStep(s) {
    step = s;
    document.getElementById('step1-view').classList.toggle('hidden', s !== 1);
    document.getElementById('step2-view').classList.toggle('hidden', s !== 2);
    document.getElementById('btn-back').style.display = s === 2 ? 'block' : 'none';
    document.getElementById('btn-action').innerText = s === 1 ? "FETCH & START ENTRY" : "COMMIT TO DB";
  }

  function showNotify(msg, type) {
    const bar = document.getElementById('notification-bar');
    bar.innerText = msg;
    bar.className = type === 'error' ? 'bg-red' : 'bg-green';
    setTimeout(() => bar.className = "", 3000);
  }

  async function deployResults() {
    showNotify("Committing to Vault...", "green");
    // Final logic: Scrape table and POST to /academic/deploy-results
    setTimeout(() => location.reload(), 2000);
  }
</script>
</body>
</html>