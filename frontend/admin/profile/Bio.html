<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institution Bio Manager</title>
    <style>
        :root { --primary: #2c3e50; --success: #2e7d32; --danger: #c62828; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--primary); }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .sign-box { padding: 15px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; display: none; text-align: center; }
        .sign-red { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); display: block; }
        .sign-green { background: #e8f5e9; color: var(--success); border: 1px solid var(--success); display: block; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }

        .dynamic-field { display: flex; gap: 10px; margin-bottom: 10px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn { padding: 12px 18px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; margin-bottom: 20px; }
        .btn-remove { background: #eee; color: var(--danger); }
        .btn-save { background: var(--success); color: white; width: 100%; font-size: 16px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="container">
    <h2>Global Institution Profile</h2>
    <div id="statusMsg" class="sign-box"></div>

    <form id="bioForm">
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="fullName" placeholder="Enter your display name" required>
        </div>

        <div class="form-group">
            <label>Short Bio</label>
            <textarea id="shortBio" rows="3" placeholder="Describe your expertise..."></textarea>
        </div>

        <div id="dynamicFields">
            <label>Custom Details (Add as many as you need)</label>
        </div>

        <button type="button" class="btn btn-add" onclick="addField()">+ Add Custom Field</button>
        <button type="submit" class="btn btn-save">Save Profile Changes</button>
    </form>
</div>

<script>
    const API_BASE = "https://fastapi-teachers.onrender.com";
    const statusMsg = document.getElementById('statusMsg');
    const token = localStorage.getItem("token");

    function addField(key = '', val = '') {
        const div = document.createElement('div');
        div.className = 'dynamic-field';
        div.innerHTML = `
            <input type="text" placeholder="Label (e.g. Office)" value="${key}" class="f-key">
            <input type="text" placeholder="Value" value="${val}" class="f-val">
            <button type="button" class="btn btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        `;
        document.getElementById('dynamicFields').appendChild(div);
    }

    // ðŸ›ï¸ Step 1: Load current data on page open
    window.onload = async () => {
        if (!token) {
            statusMsg.innerText = "Error: No login token found. Please login first.";
            statusMsg.className = "sign-box sign-red";
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/profile/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            document.getElementById('fullName').value = data.full_name || '';
            document.getElementById('shortBio').value = data.short_bio || '';

            if (data.custom_details) {
                Object.entries(data.custom_details).forEach(([k, v]) => addField(k, v));
            }
        } catch (e) { console.error("Could not load profile"); }
    };

    // ðŸ›ï¸ Step 2: Save updated data
    document.getElementById('bioForm').onsubmit = async (e) => {
        e.preventDefault();

        const details = {};
        document.querySelectorAll('.dynamic-field').forEach(row => {
            const k = row.querySelector('.f-key').value;
            const v = row.querySelector('.f-val').value;
            if (k) details[k] = v;
        });

        const payload = {
            full_name: document.getElementById('fullName').value,
            short_bio: document.getElementById('shortBio').value,
            custom_details: details
        };

        try {
            const res = await fetch(`${API_BASE}/profile/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                statusMsg.innerText = "Profile updated successfully!";
                statusMsg.className = "sign-box sign-green";
            } else {
                statusMsg.innerText = "Failed to save profile.";
                statusMsg.className = "sign-box sign-red";
            }
        } catch (err) {
            statusMsg.innerText = "Connection error.";
            statusMsg.className = "sign-box sign-red";
        }
    };
</script>
</body>
</html>