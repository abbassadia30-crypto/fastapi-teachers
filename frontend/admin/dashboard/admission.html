<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admission - Institution</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #0288d1;
            --secondary: #263238;
            --bg: #f8f9fa;
            --success: #2e7d32;
            --danger: #d32f2f;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--secondary); padding-bottom: 50px; }

        header {
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; box-shadow: 0 2px 15px rgba(0,0,0,0.04);
            position: sticky; top: 0; z-index: 100;
        }

        .back-link { border: none; background: none; font-weight: 600; cursor: pointer; color: #666; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .back-link:hover { color: var(--primary); }

        .scan-btn-modern {
            background: linear-gradient(135deg, var(--primary), #00bcd4);
            color: white; border: none; padding: 10px 18px; border-radius: 30px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }

        /* üè∑Ô∏è Tag Container & Progress */
        #confirmationArea { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.5s ease; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .student-tag {
            background: white; border: 1.5px solid #e0e0e0; color: #555;
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .student-tag:hover { border-color: var(--primary); color: var(--primary); }
        .student-tag.active { background: var(--primary); border-color: var(--primary); color: white; }

        .bulk-actions { margin-top: 15px; display: flex; gap: 10px; }
        .bulk-confirm-btn { flex: 2; background: var(--success); color: white; border: none; padding: 10px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 13px; }

        .form-container { padding: 0 20px 20px 20px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #eee; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 6px; color: #999; text-transform: uppercase; letter-spacing: 1px; }

        input, select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1.5px solid #f0f0f0; box-sizing: border-box; font-size: 14px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .sign-box { padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: 600; display: none; }
        .sign-green { background: #ecfdf5; color: var(--success); border: 1px solid #10b981; }
        .sign-red { background: #fef2f2; color: var(--danger); border: 1px solid #ef4444; }

        .submit-btn {
            background: var(--secondary); color: white; border: none; padding: 16px;
            width: 100%; border-radius: 14px; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }

        .flex-row-btn {
            background: #fff; color: var(--primary); border: 1px dashed #cbd5e1;
            padding: 10px; width: 100%; border-radius: 10px; cursor: pointer; margin: 10px 0; font-weight: 600;
        }

        .del-field-btn {
            background: #fef2f2; color: var(--danger); border: none;
            width: 50px; height: 40px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }

        .scanner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <button class="back-link" onclick="location.href='dashboard.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
    </button>
    <button class="scan-btn-modern" onclick="triggerScan()">AI Scan Register</button>
</header>

<input type="file" id="cameraInput" accept="image/*" capture="camera" style="display:none;" onchange="handleImageScan(event)">

<div id="scanOverlay" class="scanner-overlay">
    <div style="width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
    <p style="margin-top:15px; font-weight:700; color: var(--primary);">OCR IN PROGRESS...</p>
</div>

<div id="confirmationArea">
    <div class="progress-header">
        <label>Scanned Queue</label>
        <span id="progressCount" class="progress-badge">0 Students</span>
    </div>
    <div id="tagContainer" class="tag-container"></div>
    <div class="bulk-actions">
        <button class="bulk-confirm-btn" id="bulkConfirmBtn" onclick="processAllScanned()">Process All Scanned Students</button>
        <button onclick="cancelBulk()" style="background:#eee; border:none; padding:10px; border-radius:10px; cursor:pointer;">Clear</button>
    </div>
</div>

<div class="form-container">
    <div id="statusBox" class="sign-box"></div>
    <div class="card">
        <form id="admissionForm">
            <div class="input-group"><label>Full Name</label><input type="text" id="stdName" required></div>
            <div class="input-group"><label>Father's Name</label><input type="text" id="fatherName" required></div>
            <div class="input-group">
                <label>Section / Class</label>
                <select id="sectionSelect" onchange="checkCustom(this)" required></select>
            </div>
            <div class="input-group" id="customSectionGroup" style="display:none;"><label>New Section</label><input type="text" id="newSectionInput"></div>
            <div class="input-group"><label>Admission Fee</label><input type="number" id="stdFee" value="0"></div>

            <div id="flexibleRows"></div>
            <button type="button" class="flex-row-btn" onclick="addNewRow()">+ Add Extra Field</button>
            <button type="submit" class="submit-btn" id="subBtn">Confirm Admission</button>
        </form>
    </div>
</div>

<script src="capacitor.js"></script>
<script src="js/storage.js"></script>

<script>
    const API_URL = "https://fastapi-teachers.onrender.com";
    let authToken = null; // Standardized variable name
    let bulkData = [];
    let activeIndex = null;

    // --- 1. INITIALIZATION ---
    window.onload = async () => {
        // Safe token retrieval
        authToken = await AppStorage.get('institutionToken');

        if (!authToken) {
            window.location.replace("login.html");
            return;
        }

        await loadSections();
    };

    // --- 2. STATUS NOTIFICATION (Sign Box) ---
    function showStatus(msg, isSuccess) {
        const box = document.getElementById('statusBox');
        if(!box) return;

        box.innerText = msg;
        box.className = isSuccess ? "sign-box sign-green" : "sign-box sign-red";
        box.style.display = 'block';

        // Native Haptics
        if (window.AppHaptics) {
            window.AppHaptics.notification(isSuccess ? 'SUCCESS' : 'ERROR');
        }

        setTimeout(() => box.style.display = 'none', 4000);
    }

    // --- 3. SECTION MANAGEMENT ---
    async function loadSections() {
        const select = document.getElementById('sectionSelect');
        try {
            const res = await fetch(`${API_URL}/dashboard/sections`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (res.status === 401) window.location.replace("login.html");

            const sections = await res.json();
            select.innerHTML = '<option value="" disabled selected>Select Section</option>';

            sections.forEach(sec => {
                const opt = document.createElement('option');
                opt.value = sec;
                opt.textContent = sec;
                select.appendChild(opt);
            });
        } catch (e) {
            console.error("Section load failed");
        }

        // Add option to create new
        const addNew = document.createElement('option');
        addNew.value = "ADD_NEW";
        addNew.textContent = "+ Create New Section";
        select.appendChild(addNew);
    }

    // --- 4. OCR / AI SCANNING ---
    async function handleImageScan(event) {
        const file = event.target.files[0];
        if (!file) return;

        const overlay = document.getElementById('scanOverlay');
        overlay.style.display = 'flex';

        try {
            // Initialize Tesseract Worker
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            // Perform Scan
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();

            processHighAIScan(text);
        } catch (e) {
            showStatus("AI Scan failed. Try a clearer photo.", false);
        } finally {
            overlay.style.display = 'none';
        }
    }

    function processHighAIScan(rawText) {
        // Logic to split lines and clean up typical OCR artifacts
        const lines = rawText.split('\n').filter(l => l.trim().length > 3);

        bulkData = lines.map(line => {
            // Standardizing separators for institution lists (names, fathers, etc)
            const parts = line.split(/[:\-,|]/);
            return {
                name: parts[0]?.trim() || "New Student",
                father: parts[1]?.trim() || "",
                extra: parts[2]?.trim() || ""
            };
        });

        renderTags();
        showStatus(`Detected ${bulkData.length} students.`, true);
    }

    // --- 5. FORM SUBMISSION ---
    document.getElementById('admissionForm').onsubmit = async (e) => {
        e.preventDefault();

        const btn = document.getElementById('subBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        let section = document.getElementById('sectionSelect').value;
        if(section === "ADD_NEW") {
            section = document.getElementById('newSectionInput').value.trim();
        }

        if(!section) {
            showStatus("Please select or name a section", false);
            btn.disabled = false;
            btn.innerText = originalText;
            return;
        }

        const extraData = {};
        document.querySelectorAll('.row-item').forEach(row => {
            const k = row.querySelector('.extra-key').value.trim();
            const v = row.querySelector('.extra-val').value.trim();
            if(k) extraData[k] = v;
        });

        const payload = {
            name: document.getElementById('stdName').value.trim(),
            father_name: document.getElementById('fatherName').value.trim(),
            section: section,
            fee: parseFloat(document.getElementById('stdFee').value || 0),
            extra_fields: extraData
        };

        try {
            const res = await fetch(`${API_URL}/dashboard/admit-student`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                showStatus("Admission Complete!", true);

                // If we were processing a scanned student, remove them from the bulk list
                if(activeIndex !== null) {
                    bulkData.splice(activeIndex, 1);
                    activeIndex = null;
                    renderTags();
                }

                document.getElementById('admissionForm').reset();
                document.getElementById('flexibleRows').innerHTML = "";
            } else {
                showStatus("Failed to save to database.", false);
            }
        } catch (err) {
            showStatus("Network Error: Check internet connection.", false);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    // (UI helper functions like renderTags, selectStudent, and cancelBulk remain logic-heavy but should be included)
</script>
</body>
</html>