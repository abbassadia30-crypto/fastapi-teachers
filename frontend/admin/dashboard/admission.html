<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admission - Institution</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #0288d1;
            --secondary: #263238;
            --bg: #f8f9fa;
            --success: #2e7d32;
            --danger: #d32f2f;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--secondary); padding-bottom: 50px; }

        header {
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; box-shadow: 0 2px 15px rgba(0,0,0,0.04);
            position: sticky; top: 0; z-index: 100;
        }

        .back-link { border: none; background: none; font-weight: 600; cursor: pointer; color: #666; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .back-link:hover { color: var(--primary); }

        .scan-btn-modern {
            background: linear-gradient(135deg, var(--primary), #00bcd4);
            color: white; border: none; padding: 10px 18px; border-radius: 30px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }

        /* üè∑Ô∏è Tag Container & Progress */
        #confirmationArea { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.5s ease; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .student-tag {
            background: white; border: 1.5px solid #e0e0e0; color: #555;
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .student-tag:hover { border-color: var(--primary); color: var(--primary); }
        .student-tag.active { background: var(--primary); border-color: var(--primary); color: white; }

        .bulk-actions { margin-top: 15px; display: flex; gap: 10px; }
        .bulk-confirm-btn { flex: 2; background: var(--success); color: white; border: none; padding: 10px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 13px; }

        .form-container { padding: 0 20px 20px 20px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #eee; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 6px; color: #999; text-transform: uppercase; letter-spacing: 1px; }

        input, select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1.5px solid #f0f0f0; box-sizing: border-box; font-size: 14px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .sign-box { padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: 600; display: none; }
        .sign-green { background: #ecfdf5; color: var(--success); border: 1px solid #10b981; }
        .sign-red { background: #fef2f2; color: var(--danger); border: 1px solid #ef4444; }

        .submit-btn {
            background: var(--secondary); color: white; border: none; padding: 16px;
            width: 100%; border-radius: 14px; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }

        .flex-row-btn {
            background: #fff; color: var(--primary); border: 1px dashed #cbd5e1;
            padding: 10px; width: 100%; border-radius: 10px; cursor: pointer; margin: 10px 0; font-weight: 600;
        }

        .del-field-btn {
            background: #fef2f2; color: var(--danger); border: none;
            width: 50px; height: 40px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }

        .scanner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <button class="back-link" onclick="location.href='dashboard.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
    </button>
    <button class="scan-btn-modern" onclick="triggerScan()">AI Scan Register</button>
</header>

<input type="file" id="cameraInput" accept="image/*" capture="camera" style="display:none;" onchange="handleImageScan(event)">

<div id="scanOverlay" class="scanner-overlay">
    <div style="width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
    <p style="margin-top:15px; font-weight:700; color: var(--primary);">OCR IN PROGRESS...</p>
</div>

<div id="confirmationArea">
    <div class="progress-header">
        <label>Scanned Queue</label>
        <span id="progressCount" class="progress-badge">0 Students</span>
    </div>
    <div id="tagContainer" class="tag-container"></div>
    <div class="bulk-actions">
        <button class="bulk-confirm-btn" id="bulkConfirmBtn" onclick="processAllScanned()">Process All Scanned Students</button>
        <button onclick="cancelBulk()" style="background:#eee; border:none; padding:10px; border-radius:10px; cursor:pointer;">Clear</button>
    </div>
</div>

<div class="form-container">
    <div id="statusBox" class="sign-box"></div>
    <div class="card">
        <form id="admissionForm">
            <div class="input-group"><label>Full Name</label><input type="text" id="stdName" required></div>
            <div class="input-group"><label>Father's Name</label><input type="text" id="fatherName" required></div>
            <div class="input-group">
                <label>Section / Class</label>
                <select id="sectionSelect" onchange="checkCustom(this)" required></select>
            </div>
            <div class="input-group" id="customSectionGroup" style="display:none;"><label>New Section</label><input type="text" id="newSectionInput"></div>
            <div class="input-group"><label>Admission Fee</label><input type="number" id="stdFee" value="0"></div>

            <div id="flexibleRows"></div>
            <button type="button" class="flex-row-btn" onclick="addNewRow()">+ Add Extra Field</button>
            <button type="submit" class="submit-btn" id="subBtn">Confirm Admission</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://fastapi-teachers.onrender.com";
    const token = localStorage.getItem('institutionToken');
    let bulkData = [];
    let initialScanCount = 0;
    let activeIndex = null;

    window.onload = async () => { await loadSections(); };

    function showStatus(msg, isSuccess) {
        const box = document.getElementById('statusBox');
        box.innerText = msg;
        box.className = isSuccess ? "sign-box sign-green" : "sign-box sign-red";
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }

    async function loadSections() {
        const select = document.getElementById('sectionSelect');
        try {
            const res = await fetch(`${API_URL}/dashboard/sections`, { headers: { 'Authorization': `Bearer ${token}` } });
            const sections = await res.json();
            select.innerHTML = '<option value="" disabled selected>Select Section</option>';
            sections.forEach(sec => select.innerHTML += `<option value="${sec}">${sec}</option>`);
        } catch (e) { console.error("Load failed"); }
        select.innerHTML += '<option value="ADD_NEW">+ Create New Section</option>';
    }

    function checkCustom(select) { document.getElementById('customSectionGroup').style.display = (select.value === "ADD_NEW") ? "block" : "none"; }

    function addNewRow(label = "", value = "") {
        const div = document.createElement('div');
        div.className = "row-item";
        div.style.display = "flex"; div.style.gap = "8px"; div.style.marginBottom = "10px";
        div.innerHTML = `
            <input type="text" placeholder="Field" class="extra-key" style="width:40%;" value="${label}">
            <input type="text" placeholder="Value" class="extra-val" style="width:50%;" value="${value}">
            <button type="button" class="del-field-btn" onclick="this.parentElement.remove()">Delete</button>`;
        document.getElementById('flexibleRows').appendChild(div);
    }

    function triggerScan() { document.getElementById('cameraInput').click(); }

    async function handleImageScan(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('scanOverlay').style.display = 'flex';
        try {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            processHighAIScan(text);
        } catch (e) { showStatus("Scan failed.", false); }
        finally { document.getElementById('scanOverlay').style.display = 'none'; }
    }

    function processHighAIScan(rawText) {
        const lines = rawText.split('\n').filter(l => l.trim().length > 5);
        bulkData = lines.map(line => {
            const parts = line.split(/[:\-,|]/);
            return {
                name: parts[0]?.trim() || "Unknown Student",
                father: parts[1]?.trim() || "Not Detected",
                extra: parts[2]?.trim() || ""
            };
        });
        initialScanCount = bulkData.length;
        renderTags();
    }

    function renderTags() {
        const container = document.getElementById('tagContainer');
        const badge = document.getElementById('progressCount');
        container.innerHTML = "";

        if(bulkData.length > 0) {
            document.getElementById('confirmationArea').style.display = 'block';
            badge.innerText = `${bulkData.length} Students Left`;
        } else {
            document.getElementById('confirmationArea').style.display = 'none';
        }

        bulkData.forEach((item, index) => {
            const tag = document.createElement('div');
            tag.className = `student-tag ${activeIndex === index ? 'active' : ''}`;
            tag.innerHTML = `${item.name} <span>‚úï</span>`;
            tag.onclick = (e) => {
                if(e.target.tagName === 'SPAN') {
                    bulkData.splice(index, 1);
                    renderTags();
                } else {
                    selectStudent(index);
                }
            };
            container.appendChild(tag);
        });
    }

    function selectStudent(index) {
        activeIndex = index;
        const s = bulkData[index];
        document.getElementById('stdName').value = s.name;
        document.getElementById('fatherName').value = s.father;
        document.getElementById('flexibleRows').innerHTML = "";
        if(s.extra) addNewRow("Scan Note", s.extra);
        renderTags();
    }

    async function processAllScanned() {
        let section = document.getElementById('sectionSelect').value;
        if(!section) { showStatus("Select Section First", false); return; }
        if(section === "ADD_NEW") section = document.getElementById('newSectionInput').value;

        const fee = parseFloat(document.getElementById('stdFee').value || 0);
        const btn = document.getElementById('bulkConfirmBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";

        let successCount = 0;
        for(let student of [...bulkData]) {
            const payload = {
                name: student.name,
                father_name: student.father,
                section: section,
                fee: fee,
                extra_fields: { "AI_Scan": student.extra || "Verified" }
            };
            try {
                const res = await fetch(`${API_URL}/dashboard/admit-student`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if(res.ok) successCount++;
            } catch (e) {}
        }

        showStatus(`Admitted ${successCount} students to institution!`, true);
        cancelBulk();
        btn.disabled = false;
        btn.innerText = "Process All Scanned Students";
    }

    function cancelBulk() {
        bulkData = [];
        activeIndex = null;
        renderTags();
    }

    document.getElementById('admissionForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('subBtn');
        btn.disabled = true;

        let section = document.getElementById('sectionSelect').value;
        if(section === "ADD_NEW") section = document.getElementById('newSectionInput').value;

        const extraData = {};
        document.querySelectorAll('.row-item').forEach(row => {
            const k = row.querySelector('.extra-key').value.trim();
            const v = row.querySelector('.extra-val').value.trim();
            if(k) extraData[k] = v;
        });

        const payload = {
            name: document.getElementById('stdName').value,
            father_name: document.getElementById('fatherName').value,
            section: section,
            fee: parseFloat(document.getElementById('stdFee').value || 0),
            extra_fields: extraData
        };

        try {
            const res = await fetch(`${API_URL}/dashboard/admit-student`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                showStatus("Admission Complete!", true);
                if(activeIndex !== null) {
                    bulkData.splice(activeIndex, 1);
                    activeIndex = null;
                    renderTags();
                }
                document.getElementById('admissionForm').reset();
            } else {
                showStatus("Error in saving.", false);
            }
        } catch (err) { showStatus("Network Error.", false); }
        finally { btn.disabled = false; }
    };
</script>
</body>
</html>