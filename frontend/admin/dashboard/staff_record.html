<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staff Records | Institution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0288d1; --bg: #f4f6f8; --text: #2c3e50; --success: #2e7d32; --danger: #c62828; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: var(--primary); color: white; padding: 30px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* üü¢ / üî¥ Sign Box (Notifications) */
        #signBox {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 15px 25px; border-radius: 12px; font-weight: 700;
            display: none; z-index: 4000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-width: 280px; text-align: center;
        }
        .sign-green { background: #43a047; color: white; display: block !important; }
        .sign-red { background: #e53935; color: white; display: block !important; }

        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .search { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 1.5px solid #ddd; outline: none; font-family: inherit; box-sizing: border-box; transition: 0.3s; font-size: 16px; }
        .search:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(2,136,209,0.1); }

        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 6px solid var(--primary); position: relative; }
        .card h3 { margin: 0; color: var(--primary); font-size: 18px; font-weight: 800; }
        .card p { margin: 5px 0; font-size: 14px; color: #666; }

        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn-action { padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; flex: 1; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-edit { background: #e3f2fd; color: var(--primary); }
        .btn-del { background: #ffebee; color: var(--danger); }
        .btn-zoom { background: #f5f5f5; color: #555; }
        .btn-back { background: #546e7a; color: white; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; margin-top: 10px; cursor: pointer; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; }

        .modal-input { width: 100%; padding: 12px; margin: 8px 0 15px; border: 1.5px solid #edf2f7; border-radius: 10px; box-sizing: border-box; font-family: inherit; background: #f8fafc; font-size: 16px; }
        .modal-label { font-size: 11px; font-weight: 800; color: #95a5a6; text-transform: uppercase; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal-confirm { background: var(--danger); color: white; padding: 14px; border-radius: 12px; border: none; font-weight: 700; flex: 1; cursor: pointer; }
        .btn-modal-cancel { background: #f1f3f4; color: var(--text); padding: 14px; border-radius: 12px; border: none; font-weight: 700; flex: 1; cursor: pointer; }

        #auth-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 5000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="auth-overlay">Verifying Session...</div>
<div id="signBox"></div>

<header>
    <h1 style="margin:0;">üìã Staff Directory</h1>
    <p style="font-size: 13px; opacity: 0.9; margin-top: 5px;">Managing personnel for the <strong>institution</strong></p>
</header>

<div class="container">
    <input class="search" id="search" placeholder="Search by name, role, or contact..." oninput="filterStaff()">
    <div id="staffList">Connecting to institution database...</div>
    <button type="button" class="btn-back" onclick="window.location.href='dashboard.html'">‚Üê Dashboard</button>
</div>

<div id="zoomModal" class="modal">
    <div class="modal-content">
        <h3 id="zoomName" style="color: var(--primary); margin-top:0;"></h3>
        <div id="zoomDetails" style="font-size: 14px; line-height: 1.8;"></div>
        <button class="btn-back" onclick="closeModals()">Close View</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--primary);">Edit Staff Profile</h3>
        <input type="hidden" id="editId">
        <label class="modal-label">Full Name</label>
        <input id="editName" class="modal-input">
        <label class="modal-label">Role / Position</label>
        <input id="editPosition" class="modal-input">
        <label class="modal-label">Contact Number</label>
        <input id="editContact" class="modal-input" type="tel">
        <div id="extraEditFields"></div>
        <button class="btn-back" id="saveEditBtn" onclick="saveEdit()" style="background:var(--primary)">Update Record</button>
        <button class="btn-back" onclick="closeModals()" style="background:transparent; color:#95a5a6; font-size: 13px;">Discard Changes</button>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span style="font-size: 50px;">‚ö†Ô∏è</span>
        <h3 style="margin: 10px 0; color: var(--danger);">Confirm Removal</h3>
        <p style="font-size: 14px; color: #64748b;">Remove <strong id="delStaffName"></strong> from the <strong>institution</strong>?</p>
        <input type="hidden" id="delStaffId">
        <div class="btn-group">
            <button class="btn-modal-cancel" onclick="closeModals()">No, Keep</button>
            <button class="btn-modal-confirm" id="confirmDelBtn" onclick="executeDelete()">Yes, Delete</button>
        </div>
    </div>
</div>

<script src="../../capacitor.js"></script>
<script src="../../js/storage.js"></script>

<script>
    const API = "https://fastapi-teachers.onrender.com";
    let authToken = null;
    let allStaff = [];

    // --- 1. INITIALIZATION ---
    window.onload = async () => {
        authToken = await AppStorage.get('institutionToken');

        if (!authToken) {
            window.location.replace("../index.html");
            return;
        }

        document.getElementById('auth-overlay').style.display = 'none';
        await fetchStaff();
    };

    function showSign(msg, isSuccess) {
        const box = document.getElementById('signBox');
        box.innerText = msg;
        box.className = isSuccess ? "sign-green" : "sign-red";
        box.style.display = 'block';

        if (window.AppHaptics) {
            window.AppHaptics.notification(isSuccess ? 'SUCCESS' : 'ERROR');
        }

        setTimeout(() => {
            box.style.display = 'none';
            box.className = '';
        }, 3000);
    }

    async function fetchStaff() {
        try {
            const res = await fetch(`${API}/dashboard/Staff_list`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (res.status === 401) window.location.replace("../index.html");

            const result = await res.json();
            allStaff = result.rows || result || [];
            renderGrid(allStaff);
        } catch (err) {
            showSign("Institution server sync failed", false);
        }
    }

    // --- UI RENDERING ---
    function renderGrid(data) {
        const grid = document.getElementById('staffList');
        if (!data || data.length === 0) {
            grid.innerHTML = "<p style='text-align:center; padding:50px; color:#95a5a6;'>No records found.</p>";
            return;
        }
        grid.innerHTML = data.map(s => `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h3>${s.name}</h3>
                    <span style="font-size:10px; background:#e3f2fd; color:var(--primary); padding:2px 8px; border-radius:10px; font-weight:800; text-transform:uppercase;">
                        ${s.position}
                    </span>
                </div>
            </div>
            <p style="margin-top:10px;"><strong>Contact:</strong> ${s.contact || s.phone || 'N/A'}</p>
            <div class="actions">
                <button class="btn-action btn-zoom" onclick="zoomStaff(${s.id})">üîç View</button>
                <button class="btn-action btn-edit" onclick="openEdit(${s.id})">‚úèÔ∏è Edit</button>
                <button class="btn-action btn-del" onclick="askDelete(${s.id}, '${s.name}')">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
    }

    function filterStaff() {
        const q = document.getElementById('search').value.toLowerCase().trim();
        renderGrid(allStaff.filter(s =>
            s.name.toLowerCase().includes(q) ||
            s.position.toLowerCase().includes(q) ||
            (s.contact && s.contact.includes(q))
        ));
    }

    // --- DYNAMIC ROW LOGIC ---
    function addStaffExtraRow() {
        const container = document.getElementById('extraEditFields');
        const div = document.createElement('div');
        div.className = "dynamic-staff-row";
        div.style = "display: flex; gap: 8px; margin-bottom: 12px; align-items: center;";

        div.innerHTML = `
            <div style="flex:1">
                <label class="modal-label" style="font-size: 9px;">Field Name</label>
                <input type="text" class="modal-input new-key" placeholder="e.g. Salary" style="margin:0; font-size:14px;">
            </div>
            <div style="flex:1">
                <label class="modal-label" style="font-size: 9px;">Value</label>
                <input type="text" class="modal-input new-val" placeholder="e.g. 25000" style="margin:0; font-size:14px;">
            </div>
            <button type="button" onclick="this.parentElement.remove()"
                style="background:#ffebee; border:none; color:var(--danger); margin-top:15px; cursor:pointer; font-size:18px; padding:5px; border-radius:50%; width:30px; height:30px;">‚úï</button>
        `;
        container.appendChild(div);
    }

    // --- MODAL & CRUD LOGIC ---

    function zoomStaff(id) {
        const s = allStaff.find(x => x.id === id);
        document.getElementById('zoomName').innerText = s.name;
        let html = `<p><strong>Position:</strong> ${s.position}</p><p><strong>Contact:</strong> ${s.contact || 'N/A'}</p><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">`;
        if (s.extra_details) {
            Object.entries(s.extra_details).forEach(([k, v]) => {
                html += `<p><strong>${k}:</strong> ${v}</p>`;
            });
        }
        document.getElementById('zoomDetails').innerHTML = html;
        document.getElementById('zoomModal').style.display = 'flex';
    }

    function openEdit(id) {
        const s = allStaff.find(x => x.id === id);
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editPosition').value = s.position;
        document.getElementById('editContact').value = s.contact || s.phone || "";

        const extraDiv = document.getElementById('extraEditFields');
        extraDiv.innerHTML = "";

        if (s.extra_details) {
            Object.entries(s.extra_details).forEach(([k, v]) => {
                extraDiv.innerHTML += `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="flex:1">
                            <label class="modal-label">${k}</label>
                            <input class="modal-input existing-extra" data-key="${k}" value="${v}">
                        </div>
                        <button type="button" onclick="this.parentElement.remove()" style="background:none; border:none; color:var(--danger); cursor:pointer; margin-top:10px;">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        // Ensure the "+ Add Row" button exists if not in HTML
        if (!document.getElementById('addRowBtn')) {
            const btn = document.createElement('button');
            btn.id = "addRowBtn";
            btn.innerText = "+ Add Custom Field";
            btn.type = "button";
            btn.style = "width:100%; padding:10px; margin-bottom:15px; border:1px dashed var(--primary); background:none; color:var(--primary); border-radius:10px; cursor:pointer; font-weight:600;";
            btn.onclick = addStaffExtraRow;
            extraDiv.after(btn);
        }

        document.getElementById('editModal').style.display = 'flex';
    }

    async function saveEdit() {
        const id = document.getElementById('editId').value;
        const btn = document.getElementById('saveEditBtn');
        const originalText = btn.innerText;
        btn.innerText = "Syncing...";
        btn.disabled = true;

        const extras = {};

        // 1. Collect remaining existing extra fields
        document.querySelectorAll('.existing-extra').forEach(i => {
            extras[i.getAttribute('data-key')] = i.value.trim();
        });

        // 2. Collect newly added dynamic rows
        document.querySelectorAll('.dynamic-staff-row').forEach(row => {
            const k = row.querySelector('.new-key').value.trim();
            const v = row.querySelector('.new-val').value.trim();
            if(k) extras[k] = v;
        });

        const payload = {
            name: document.getElementById('editName').value.trim(),
            position: document.getElementById('editPosition').value.trim(),
            contact: document.getElementById('editContact').value.trim(),
            extra_details: extras
        };

        try {
            const res = await fetch(`${API}/dashboard/update_staff/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                showSign("Profile synced successfully!", true);
                closeModals();
                await fetchStaff();
            } else {
                showSign("Update rejected by server", false);
            }
        } catch (e) { showSign("Connection to institution lost", false); }
        finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function askDelete(id, name) {
        document.getElementById('delStaffId').value = id;
        document.getElementById('delStaffName').innerText = name;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    async function executeDelete() {
        const id = document.getElementById('delStaffId').value;
        const btn = document.getElementById('confirmDelBtn');
        btn.innerText = "Removing...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API}/dashboard/delete_staff/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if(res.ok) {
                showSign("Staff removed from records", true);
                closeModals();
                await fetchStaff();
            }
        } catch (e) { showSign("Delete failed", false); }
        finally {
            btn.innerText = "Yes, Delete";
            btn.disabled = false;
        }
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        const addBtn = document.getElementById('addRowBtn');
        if(addBtn) addBtn.remove(); // Remove button to prevent duplication on next open
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) closeModals();
    }
</script>
</body>
</html>