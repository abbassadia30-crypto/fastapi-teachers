<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Institution Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="capacitor.js"></script>
    <script src="js/storage.js"></script>
    <style>
        /* 1. Global Reset & Hidden State */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: #f4f7f6;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        /* Add hover/active state for links */
        a:active { opacity: 0.6; }

        /* Optional: Style for a future reset modal if you want to keep it on one page */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; align-items: center;
            justify-content: center; z-index: 4000;
        }

        /* 2. The "Pre-reveal" Loader */
        #app-gate-loader {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(2, 136, 209, 0.1);
            border-left-color: #0288d1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        body.ready { opacity: 1; }
        body.ready #app-gate-loader { opacity: 0; pointer-events: none; }

        #notification-bar {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; padding: 15px; border-radius: 15px;
            color: white; font-weight: 600; text-align: center;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .show-notify { top: 20px !important; }
        .bg-red { background: #e53935; border: 1px solid #b71c1c; }
        .bg-green { background: #43a047; border: 1px solid #1b5e20; }

        .card {
            background: white; padding: 40px 30px; border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 85%;
            max-width: 350px; text-align: center;
        }
        .input-group { margin-bottom: 20px; text-align: left; }
        input {
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #eee;
            background: #f9f9f9; box-sizing: border-box; outline: none;
            transition: 0.3s; font-size: 16px;
        }
        input:focus { border-color: #0288d1; background: #fff; }
        .btn {
            width: 100%; padding: 15px; background: #0288d1; color: white;
            border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="app-gate-loader">
    <div class="spinner"></div>
</div>

<div id="notification-bar"></div>

<div class="card">
    <h2>Starlight Login</h2>
    <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="input-group">
            <input type="email" id="email" placeholder="Institution Email" required>
        </div>
        <div class="input-group" style="margin-bottom: 5px;">
            <input type="password" id="password" placeholder="Password" required>
        </div>

        <div style="text-align: right; margin-bottom: 20px;">
            <a href="forgot-password.html"
               style="color: #666; font-size: 11px; text-decoration: none; font-weight: 600; cursor: pointer;">
                Forgot Password?
            </a>
        </div>

        <button type="submit" class="btn" id="loginBtn">Login</button>
    </form>

    <p style="font-size: 12px; margin-top: 15px; color: #666;">
        New to the <b>institution</b>?
        <a href="signup.html" style="color: #0288d1; text-decoration: none; font-weight: 600;">Create Account</a>
    </p>
</div>

<script>
    const API_BASE = "https://fastapi-teachers.onrender.com";

    async function checkExistingSession() {
        if (typeof AppStorage === 'undefined' || !AppStorage.get) {
            setTimeout(checkExistingSession, 30);
            return;
        }

        try {
            const token = await AppStorage.get('user_email');
            const inst_token = await AppStorage.get('institutionToken');
            const role = await AppStorage.get('user_role');
            const Identity = await AppStorage.get(`${role}_identity`);
            const auth_token = await AppStorage.get('auth_token')

            if ((token && auth_token) && inst_token && role && Identity) {
                window.location.replace(`${role}/dashboard/dashboard.html`);
            }
            else if ((token && auth_token) && role && Identity && !inst_token) {
                window.location.replace(`${role}/setups/no-institution.html`);
            }
            else if ((token && auth_token) && role && !Identity) {
                // Simplified Identity path logic
                const path = (role === "owner" || role === "admin")
                    ? `admin/${role}_identity/create_identity.html`
                    : `${role}/setups/create_identity.html`;
                window.location.replace(path);
            }
            else if ((token && auth_token) && !role) {
                window.location.replace("roles/role.html");
            }
            else {
                document.body.classList.add('ready');
            }
        } catch (e) {
            document.body.classList.add('ready');
        }
    }

    checkExistingSession();

    const Notification = {
        el: document.getElementById('notification-bar'),
        show(msg, type) {
            this.el.innerText = msg;
            this.el.className = (type === 'success' ? 'bg-green' : 'bg-red') + ' show-notify';
            setTimeout(() => { this.el.className = ''; }, 4000);
        }
    };

    async function handleLogin(event) {
        event.preventDefault();
        const btn = document.getElementById('loginBtn');
        const emailInput = document.getElementById('email').value.trim();
        const passwordInput = document.getElementById('password').value;

        btn.disabled = true;
        btn.innerText = "Authenticating...";

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: emailInput, password: passwordInput })
            });

            const data = await response.json();

            if (response.ok) {
                // 1. Core Auth
                await AppStorage.set('user_email', emailInput);
                await AppStorage.set('auth_token', data.access_token);

                // 2. Role Status
                if (data.role && data.role !== "unassigned") {
                    await AppStorage.set('user_role', data.role);
                }

                // 3. Identity Status (Critical for your redirection logic)
                if (data.identity === true) {
                    await AppStorage.set(`${data.role}_identity`, 'verified');
                }

                // 4. Institution Status
                if (data.institution_id) {
                    await AppStorage.set('institution_id', data.institution_id);
                    await AppStorage.set('institutionToken', 'verified');
                }

                Notification.show("Login Successful!", "success");

                // 5. Trigger the Routing Logic immediately
                setTimeout(() => { checkExistingSession(); }, 1000);
            } else {
                Notification.show(data.detail || "Invalid Credentials", "error");
                btn.disabled = false;
                btn.innerText = "Login";
            }
        } catch (error) {
            Notification.show("Server Unreachable", "error");
            btn.disabled = false;
            btn.innerText = "Login";
        }
    }
</script>
</body>
</html>