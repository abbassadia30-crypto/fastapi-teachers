<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Explore | Institution Search</title>
  <style>
    /* CSS defined in head per institution standards */
    :root { --primary: #0288d1; --bg: #f4f7f6; --text: #2c3e50; --accent: #3498db; --danger: #c62828; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); }

    .header-container {
      background: white; padding: 20px; position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .header-controls { display: flex; gap: 10px; align-items: center; max-width: 600px; margin: auto; }

    .sort-select {
      background: #f1f3f4; border: none; padding: 12px; border-radius: 12px;
      font-family: inherit; font-size: 14px; color: var(--text); outline: none; cursor: pointer;
    }

    .search-bar {
      background: #f1f3f4; border-radius: 12px; padding: 12px;
      display: flex; align-items: center; gap: 10px; flex: 1;
    }
    .search-bar input { border: none; background: transparent; width: 100%; outline: none; font-size: 15px; }

    .feed-container { padding: 15px; max-width: 600px; margin: auto; min-height: 200px; }
    .profile-card {
      background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 1px solid #eee;
    }

    .label-style {
      display: block; font-size: 10px; font-weight: 800; color: #999;
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;
    }

    .field-box {
      padding: 12px; background: #f9f9f9; border-radius: 10px;
      border-left: 4px solid var(--accent); margin-bottom: 15px; font-size: 15px; font-weight: 500;
    }

    .name-header { font-size: 22px; font-weight: 700; color: var(--primary); margin: 0 0 20px 0; }

    .back-dash {
      position: fixed; bottom: 20px; right: 20px;
      background: var(--primary); color: white; border: none;
      padding: 15px 25px; border-radius: 50px; font-weight: 700;
      box-shadow: 0 4px 15px rgba(2, 136, 209, 0.4);
      cursor: pointer; text-decoration: none; z-index: 1000;
    }

    /* Red/Green Sign boxes per user method */
    .sign-box { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 20px; }
    .sign-red { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); }
    .sign-green { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }

    #loader { text-align: center; padding: 50px; color: var(--primary); font-weight: 600; }
  </style>
</head>
<body>

<div class="header-container">
  <div class="header-controls">
    <select id="sortOpt" class="sort-select">
      <option value="newest">Newest</option>
      <option value="az">A-Z</option>
      <option value="za">Z-A</option>
    </select>

    <div class="search-bar">
      <span>üîç</span>
      <input type="text" placeholder="Search name, role, or expertise..." id="globalSearch">
    </div>
  </div>
</div>

<div id="loader">Connecting to Institution Database...</div>
<div id="status-msg"></div>
<div class="feed-container" id="feed"></div>

<button class="back-dash" onclick="window.location.href='../admin/dashboard/dashboard.html'">üè† Dashboard</button>

<script>
  const API_BASE = "https://fastapi-teachers.onrender.com";
  let allProfiles = [];

  window.onload = async () => {
    try {
      const res = await fetch(`${API_BASE}/profile/profiles/all`);
      if(!res.ok) throw new Error("Server Error");

      allProfiles = await res.json();
      renderProfiles();
    } catch (e) {
      document.getElementById('status-msg').innerHTML =
              '<div class="sign-box sign-red">Offline: Cannot reach institution server. Check your connection.</div>';
    } finally {
      document.getElementById('loader').style.display = 'none';
    }

    document.getElementById('globalSearch').addEventListener('input', () => renderProfiles());
    document.getElementById('sortOpt').addEventListener('change', () => renderProfiles());
  };

  function renderProfiles() {
    const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
    const sortType = document.getElementById('sortOpt').value;
    const feed = document.getElementById('feed');
    feed.innerHTML = "";

    // Deep copy to avoid mutating original list during sort
    let filtered = [...allProfiles].filter(p => {
      const name = (p.full_name || "").toLowerCase();
      const bio = (p.short_bio || "").toLowerCase();

      // Safe check for custom_details
      let detailsMatch = false;
      if (p.custom_details && typeof p.custom_details === 'object') {
        detailsMatch = Object.values(p.custom_details).some(v =>
                String(v).toLowerCase().includes(searchTerm)
        );
      }

      return name.includes(searchTerm) || bio.includes(searchTerm) || detailsMatch;
    });

    // Sorting Logic
    if (sortType === "az") {
      filtered.sort((a, b) => a.full_name.localeCompare(b.full_name));
    } else if (sortType === "za") {
      filtered.sort((a, b) => b.full_name.localeCompare(a.full_name));
    }
    // "newest" is default if the backend returns ordered by ID desc

    if (filtered.length === 0) {
      feed.innerHTML = `<div class="sign-box sign-red">No records match "${searchTerm}"</div>`;
      return;
    }

    filtered.forEach(profile => {
      const card = document.createElement('div');
      card.className = 'profile-card';

      let customHtml = '';
      if (profile.custom_details && typeof profile.custom_details === 'object') {
        Object.entries(profile.custom_details).forEach(([key, value]) => {
          if (value) {
            customHtml += `
              <span class="label-style">${key.replace(/_/g, ' ')}</span>
              <div class="field-box">${value}</div>
            `;
          }
        });
      }

      card.innerHTML = `
        <h3 class="name-header">${profile.full_name}</h3>
        <span class="label-style">Professional Summary</span>
        <div class="field-box">${profile.short_bio || 'No bio provided.'}</div>
        ${customHtml}
      `;
      feed.appendChild(card);
    });
  }
</script>
</body>
</html>